<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingrow - Mobile Marketplace</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌱</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f4f4f5;
            overflow-x: hidden;
        }

        /* Bottom Tab Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 428px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-around;
            z-index: 100;
            box-sizing: border-box;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #a1a1aa;
            font-size: 10px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: #10b981;
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Main Content */
        .container {
            padding: 20px 16px 100px;
            max-width: 428px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-top: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
        }

        .currency-display {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #a1a1aa;
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px 16px 16px 48px;
            color: #f4f4f5;
            font-size: 16px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #a1a1aa;
            font-size: 18px;
        }

        /* Categories */
        .categories {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 8px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            text-decoration: none;
            color: #f4f4f5;
            font-size: 12px;
            text-align: center;
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.2s;
        }

        .category-item:hover {
            background: rgba(30, 41, 59, 0.95);
            border-color: #10b981;
        }

        .category-item .icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #10b981;
        }

        /* Product Grid */
        .products {
            margin-bottom: 24px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .product-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.2s;
        }

        .product-card:hover {
            background: rgba(30, 41, 59, 0.95);
            border-color: #10b981;
        }

        .product-image {
            width: 100%;
            height: 120px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: #a1a1aa;
            font-size: 14px;
        }

        .product-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .product-price {
            font-size: 16px;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 4px;
        }

        .product-seller {
            font-size: 12px;
            color: #a1a1aa;
            margin-bottom: 8px;
        }

        .product-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #a1a1aa;
        }

        .favorite-btn {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .favorite-btn.active {
            color: #ef4444;
        }

        /* Product Detail Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .popup-overlay.show {
            display: flex;
        }
        .popup-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .popup-header {
            position: sticky;
            top: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .popup-close {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .popup-close:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #f4f4f5;
        }
        .popup-body {
            padding: 0;
        }
        .product-image-gallery {
            position: relative;
            height: 300px;
            background: rgba(15, 23, 42, 0.6);
        }
        .product-image-main {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-indicators {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .image-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }
        .image-dot.active {
            background: #10b981;
            transform: scale(1.2);
        }
        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }
        .image-nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }
        .image-nav-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .image-nav-btn.disabled:hover {
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
        }
        .image-nav-prev {
            left: 12px;
        }
        .image-nav-next {
            right: 12px;
        }
        .product-detail-info {
            padding: 20px;
        }
        .product-detail-title {
            font-size: 20px;
            font-weight: bold;
            color: #f4f4f5;
            margin-bottom: 8px;
        }
        .product-detail-price {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 8px;
        }
        .seller-location {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 16px;
            padding: 4px 0;
        }
        .exchange-rates {
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
            padding: 8px;
            background: rgba(15, 23, 42, 0.2);
            border-radius: 4px;
        }
        .product-detail-section {
            margin-bottom: 20px;
        }
        .product-detail-label {
            font-size: 12px;
            color: #a1a1aa;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .product-detail-value {
            color: #f4f4f5;
            margin-bottom: 12px;
        }
        .seller-info {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .seller-profile {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .seller-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #10b981;
            flex-shrink: 0;
        }
        .seller-details {
            flex: 1;
        }
        .seller-name {
            font-weight: 500;
            color: #10b981;
            margin-bottom: 4px;
            font-size: 16px;
        }
        .seller-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .rating-stars {
            display: flex;
            gap: 2px;
        }
        .star {
            color: #fbbf24;
            font-size: 14px;
        }
        .star.empty {
            color: #4b5563;
        }
        .sales-count {
            color: #9ca3af;
            font-size: 12px;
        }
        .seller-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #a1a1aa;
        }

        /* Chat Styles */
        .back-btn {
            background: none;
            border: none;
            color: #10b981;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
        }
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #10b981;
        }
        .chat-seller-name {
            font-weight: 600;
            color: #10b981;
            font-size: 16px;
        }
        .chat-product-name {
            font-size: 12px;
            color: #94a3b8;
        }
        .chat-messages {
            flex: 1;
            padding: 16px 0;
            margin-bottom: 140px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .message.sent {
            justify-content: flex-end;
        }
        .message.received {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.sent .message-bubble {
            background: #10b981;
            color: white;
            border-bottom-right-radius: 6px;
        }
        .message.received .message-bubble {
            background: rgba(30, 41, 59, 0.6);
            color: #f4f4f5;
            border-bottom-left-radius: 6px;
        }
        .message-time {
            font-size: 11px;
            color: #6b7280;
            margin: 4px 8px 0;
        }
        .chat-input-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 428px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-top: 1px solid rgba(30, 41, 59, 0.5);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 150;
            box-sizing: border-box;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(30, 41, 59, 0.5);
            border-radius: 24px;
            background: rgba(30, 41, 59, 0.4);
            color: #f4f4f5;
            font-size: 14px;
            outline: none;
        }
        .chat-input::placeholder {
            color: #9ca3af;
        }
        .chat-input:focus {
            border-color: #10b981;
        }
        .send-btn {
            background: #10b981;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        .send-btn:hover {
            background: #059669;
        }
        .send-btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }

        /* Chat List Styles */
        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(30, 41, 59, 0.3);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-list-item:hover {
            background: rgba(30, 41, 59, 0.3);
        }
        .chat-list-item:last-child {
            border-bottom: none;
        }
        .chat-list-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #10b981;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .chat-list-info {
            flex: 1;
            min-width: 0;
        }
        .chat-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .chat-list-name {
            font-weight: 600;
            color: #f4f4f5;
            font-size: 16px;
        }
        .chat-list-time {
            font-size: 12px;
            color: #9ca3af;
        }
        .chat-list-preview {
            color: #a1a1aa;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-list-product {
            font-size: 12px;
            color: #10b981;
            margin-top: 2px;
        }
        .unread-badge {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        .popup-actions {
            padding: 16px 20px 20px;
            display: flex;
            gap: 12px;
        }
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .btn-primary {
            background: #10b981;
            color: white;
        }
        .btn-primary:hover {
            background: #059669;
        }
        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            color: #f4f4f5;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
        }

        /* Page Content */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Authentication Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 200px);
            padding: 20px 0;
        }

        .auth-form {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #f4f4f5;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            color: #f4f4f5;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .auth-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .auth-input::placeholder {
            color: #94a3b8;
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .auth-btn.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .auth-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .auth-footer {
            text-align: center;
            color: #94a3b8;
            font-size: 14px;
        }

        .auth-link {
            color: #10b981;
            cursor: pointer;
            font-weight: 500;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .demo-accounts {
            margin-top: 24px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .demo-accounts h4 {
            color: #f4f4f5;
            margin: 0 0 12px 0;
            font-size: 14px;
        }

        .demo-account {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .demo-account:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateX(4px);
        }

        .demo-account:last-child {
            margin-bottom: 0;
        }

        .demo-account span {
            color: #94a3b8;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #a1a1aa;
        }

        /* Profile Page Styles */
        .profile-section {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .profile-section .section-title { /* fixed */
            font-size: 18px;
            font-weight: 600;
            color: #f4f4f5;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Account Information Grid */
        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 14px;
            color: #94a3b8;
            font-weight: 500;
        }

        .info-value {
            font-size: 14px;
            color: #f4f4f5;
            font-weight: 400;
        }

        /* Wallet Cards */
        .wallet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .wallet-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .wallet-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 8px;
        }

        .wallet-info {
            flex: 1;
        }

        .wallet-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .wallet-value {
            font-size: 16px;
            font-weight: 600;
            color: #10b981;
        }

        /* Referrer Card */
        .referrer-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .referrer-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .referrer-avatar {
            flex-shrink: 0;
        }

        .referrer-details {
            flex: 1;
        }

        .referrer-name {
            font-size: 18px;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 4px;
        }

        .referrer-code {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .referrer-date {
            font-size: 12px;
            color: #94a3b8;
        }

        .referrer-stats {
            padding-top: 16px;
            border-top: 1px solid rgba(16, 185, 129, 0.2);
        }

        .referrer-stat {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            padding: 12px;
        }

        .referrer-stat-icon {
            font-size: 24px;
        }

        .referrer-stat-info {
            flex: 1;
        }

        .referrer-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 2px;
        }

        .referrer-stat-label {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Network Page Styles */
        .referral-section {
            margin: 24px 0;
        }

        .referral-code-card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .referral-code-input,
        .referral-link-input {
            display: flex;
            gap: 8px;
        }

        .copy-code-btn,
        .copy-link-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            width: auto;
        }

        .copy-code-btn:hover,
        .copy-link-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .referral-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .invited-users-section {
            margin: 24px 0;
        }

        .invited-users-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .invited-user-card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invited-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .invited-user-info {
            flex: 1;
        }

        .invited-user-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .invited-user-date {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Settings Grid */
        .settings-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .setting-icon {
            font-size: 18px;
            width: 40px;
        }

        .setting-label {
            flex: 1;
            font-size: 14px;
            color: #f4f4f5;
            margin-left: 12px;
        }

        .setting-toggle {
            background: #10b981;
            color: white;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 500;
        }

        .setting-toggle.inactive {
            background: #64748b;
        }

        .setting-value {
            color: #94a3b8;
            font-size: 14px;
        }

        .setting-item.clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .setting-item.clickable:hover {
            background: rgba(30, 41, 59, 0.6);
        }

        .setting-item.clickable .setting-value {
            color: #10b981;
            font-weight: 500;
        }

        /* Edit buttons */
        .edit-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .edit-btn:hover {
            background: #059669;
            transform: scale(1.05);
        }

        .edit-btn.small {
            padding: 2px 6px;
            font-size: 10px;
        }

        .edit-btn.profile-image-edit {
            background: #3b82f6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .edit-btn.profile-image-edit:hover {
            background: #2563eb;
        }

        /* Profile Actions */
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
        }

        /* Update stats-grid for profile page */
        .profile-section .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (min-width: 768px) {
            .profile-section .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #f4f4f5;
        }

        .form-input {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #f4f4f5;
            font-size: 16px;
        }

        .btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #059669;
        }

        .profile-section .btn-secondary { /* fixed */
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .profile-section .btn-secondary:hover { /* fixed */
            background: rgba(30, 41, 59, 0.95);
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
        }

        .form-help {
            font-size: 12px;
            color: #a1a1aa;
            display: block;
            margin-top: 4px;
        }

        /* Price Input */
        .price-input-container {
            position: relative;
        }

        .currency-label {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #10b981;
            font-weight: 600;
        }

        /* Image Upload */
        .image-upload-container {
            margin-bottom: 16px;
        }

        .image-upload-button {
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(30, 41, 59, 0.3);
        }

        .image-upload-button:hover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .image-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #27272a;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .image-preview-primary {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        .image-preview-primary.active {
            background: #fbbf24;
            color: #000;
        }
        .primary-badge {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            font-size: 8px;
            font-weight: bold;
            text-align: center;
            padding: 2px;
            border-radius: 0 0 6px 6px;
        }

        /* Checkbox Groups */
        .checkbox-group {
            margin-bottom: 16px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .checkbox-label:hover {
            background: rgba(30, 41, 59, 0.7);
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }

        .checkmark {
            margin-left: 8px;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 32px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .auction-fields {
            background: rgba(15, 23, 42, 0.5);
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #fbbf24;
            margin-top: 16px;
        }

        /* Responsive adjustments for form */
        @media (min-width: 768px) {
            .form-actions {
                flex-direction: row;
                justify-content: flex-end;
            }

            .form-actions .btn,
            .form-actions .btn-secondary {
                width: auto;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Marketplace Page -->
    <div id="marketplace" class="page active">
        <div class="container">
            <div class="header">
                <div class="logo">🌱 Fingrow</div>
                <div class="currency-display">
                    <div id="wldPriceMobile">1 WLD = ฿Loading...</div>
                    <div style="font-size: 10px; color: #71717a; margin-top: 2px;" id="lastUpdated">Loading...</div>
                </div>
            </div>

            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-input" id="searchInput" placeholder="ค้นหาสินค้า..." onkeyup="handleSearch()">
            </div>

            <div class="filters">
                <h2 class="section-title">กรองสินค้า</h2>

                <div class="filter-row" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <select class="form-input" id="categoryFilter" onchange="filterProducts()" style="font-size: 14px; padding: 8px 12px;">
                            <option value="">ทุกหมวดหมู่</option>
                            <option value="electronics">📱 อิเล็กทรอนิกส์</option>
                            <option value="gaming">🎮 เกมมิ่ง</option>
                            <option value="camera">📷 กล้อง</option>
                            <option value="fashion">👕 แฟชั่น</option>
                            <option value="music">🎵 เครื่องดนตรี</option>
                            <option value="books">📚 หนังสือ</option>
                            <option value="home">🏠 บ้านและสวน</option>
                            <option value="sports">⚽ กีฬา</option>
                            <option value="automotive">🚗 ยานยนต์</option>
                            <option value="toys">🎲 ของเล่น</option>
                            <option value="beauty">💄 ความงาม</option>
                            <option value="collectibles">💎 ของสะสม</option>
                            <option value="business">💼 ธุรกิจ</option>
                        </select>
                    </div>

                    <div style="flex: 1; min-width: 120px;">
                        <select class="form-input" id="conditionFilter" onchange="filterProducts()" style="font-size: 14px; padding: 8px 12px;">
                            <option value="">ทุกสภาพ</option>
                            <option value="new">ใหม่</option>
                            <option value="like-new">เหมือนใหม่</option>
                            <option value="excellent">ดีมาก</option>
                            <option value="good">ดี</option>
                            <option value="fair">ปานกลาง</option>
                            <option value="poor">เก่า</option>
                        </select>
                    </div>

                    <div style="flex: 1; min-width: 100px;">
                        <select class="form-input" id="sortFilter" onchange="filterProducts()" style="font-size: 14px; padding: 8px 12px;">
                            <option value="newest">ใหม่ล่าสุด</option>
                            <option value="price-low">ราคาต่ำ-สูง</option>
                            <option value="price-high">ราคาสูง-ต่ำ</option>
                            <option value="popular">ยอดนิยม</option>
                        </select>
                    </div>
                </div>

                <!-- Price Range Filter -->
                <div class="filter-row" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: end;">
                    <div style="flex: 0 0 90px; min-width: 90px;">
                        <label class="form-label" style="font-size: 12px; margin-bottom: 4px; display: block; color: #9ca3af;">สกุลเงิน</label>
                        <select class="form-input" id="currencyFilter" onchange="filterProducts()" style="font-size: 14px; padding: 8px 12px;">
                            <option value="WLD">WLD</option>
                            <option value="THB">THB (฿)</option>
                        </select>
                    </div>

                    <div style="flex: 1; min-width: 120px;">
                        <label class="form-label" style="font-size: 12px; margin-bottom: 4px; display: block; color: #9ca3af;">ราคาต่ำสุด</label>
                        <input type="number" class="form-input" id="minPriceFilter" placeholder="0" onchange="filterProducts()" oninput="filterProducts()" style="font-size: 14px; padding: 8px 12px;" min="0" step="0.01">
                    </div>

                    <div style="flex: 1; min-width: 120px;">
                        <label class="form-label" style="font-size: 12px; margin-bottom: 4px; display: block; color: #9ca3af;">ราคาสูงสุด</label>
                        <input type="number" class="form-input" id="maxPriceFilter" placeholder="∞" onchange="filterProducts()" oninput="filterProducts()" style="font-size: 14px; padding: 8px 12px;" min="0" step="0.01">
                    </div>

                    <div style="flex: 0 0 auto;">
                        <button class="btn-clear-price" onclick="clearPriceFilter()" style="background: #374151; color: #9ca3af; border: none; border-radius: 6px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#374151'">
                            ล้างราคา
                        </button>
                    </div>
                </div>
            </div>

            <div class="products">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 class="section-title" id="productsSectionTitle">สินค้าทั้งหมด</h2>
                    <div style="font-size: 12px; color: #a1a1aa;" id="productsCount">กำลังโหลด...</div>
                </div>
                <div class="product-grid" id="productGrid">
                    <!-- Products will be loaded dynamically -->
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #a1a1aa;">
                        <div style="font-size: 24px; margin-bottom: 8px;">📦</div>
                        <div>กำลังโหลดสินค้า...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Listing Page -->
    <!-- Listings Page (Combined Create + Orders + My Products) -->
    <div id="listings" class="page">
        <div class="container">
            <div class="header">
                <div class="logo">📋 รายการของฉัน</div>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #374151;">
                <button id="sellTab" class="tab-button active" onclick="showListingsTab('sell')" style="flex: 1; padding: 12px; border: none; background: none; color: #10b981; font-weight: bold; border-bottom: 2px solid #10b981;">
                    ➕ ลงขาย
                </button>
                <button id="myProductsTab" class="tab-button" onclick="showListingsTab('myProducts')" style="flex: 1; padding: 12px; border: none; background: none; color: #9ca3af; font-weight: bold;">
                    🛍️ สินค้าของฉัน
                </button>
                <button id="ordersTab" class="tab-button" onclick="showListingsTab('orders')" style="flex: 1; padding: 12px; border: none; background: none; color: #9ca3af; font-weight: bold;">
                    📦 คำสั่งซื้อ
                </button>
            </div>

            <!-- Sell Product Tab Content -->
            <div id="sellTabContent" class="tab-content">

            <form id="createListingForm">
                <!-- Basic Information -->
                <div class="form-section">
                    <h3 class="form-section-title">ข้อมูลพื้นฐาน</h3>

                    <div class="form-group">
                        <label class="form-label">ชื่อสินค้า *</label>
                        <input type="text" class="form-input" id="productTitle" placeholder="เช่น iPhone 14 Pro สีทอง 128GB" required>
                        <small class="form-help">กรอกชื่อสินค้าที่ชัดเจนและครบถ้วน</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">หมวดหมู่ *</label>
                        <select class="form-input" id="productCategory" required onchange="updateSubCategories()">
                            <option value="">เลือกหมวดหมู่</option>
                            <option value="electronics">อิเล็กทรอนิกส์</option>
                            <option value="fashion">แฟชั่น</option>
                            <option value="home">บ้านและสวน</option>
                            <option value="sports">กีฬาและนันทนาการ</option>
                            <option value="automotive">ยานยนต์</option>
                            <option value="books">หนังสือและสื่อ</option>
                            <option value="toys">ของเล่นและเกม</option>
                            <option value="beauty">ความงามและสุขภาพ</option>
                            <option value="collectibles">ของสะสม</option>
                            <option value="business">อุปกรณ์ธุรกิจ</option>
                            <option value="other">อื่นๆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">หมวดหมู่ย่อย</label>
                        <select class="form-input" id="productSubCategory">
                            <option value="">เลือกหมวดหมู่หลักก่อน</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">แบรนด์</label>
                        <input type="text" class="form-input" id="productBrand" placeholder="เช่น Apple, Samsung, Nike">
                    </div>

                    <div class="form-group">
                        <label class="form-label">รุ่น/โมเดล</label>
                        <input type="text" class="form-input" id="productModel" placeholder="เช่น iPhone 14 Pro, Galaxy S23">
                    </div>
                </div>

                <!-- Condition & Details -->
                <div class="form-section">
                    <h3 class="form-section-title">สภาพและรายละเอียด</h3>

                    <div class="form-group">
                        <label class="form-label">สภาพสินค้า *</label>
                        <select class="form-input" id="productCondition" required>
                            <option value="">เลือกสภาพสินค้า</option>
                            <option value="new">ใหม่ - ยังไม่เคยใช้งาน</option>
                            <option value="like-new">เหมือนใหม่ - ใช้งานน้อยมาก</option>
                            <option value="excellent">ดีมาก - ใช้งานเล็กน้อย ไม่มีรอยเสียหาย</option>
                            <option value="good">ดี - ใช้งานปกติ มีร่องรอยการใช้งานเล็กน้อย</option>
                            <option value="fair">ปานกลาง - มีร่องรอยการใช้งานชัดเจน</option>
                            <option value="poor">เก่า - มีร่องรอยการใช้งานมาก หรือมีข้อบกพร่อง</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">คำอธิบายสินค้า *</label>
                        <textarea class="form-input" id="productDescription" rows="5" placeholder="อธิบายรายละเอียด คุณสมบัติ สภาพการใช้งาน และสิ่งที่รวมอยู่ในกล่อง..." required></textarea>
                        <small class="form-help">อธิบายให้ละเอียดเพื่อช่วยให้ผู้ซื้อเข้าใจสินค้ามากขึ้น</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">สี</label>
                        <input type="text" class="form-input" id="productColor" placeholder="เช่น ทอง, ดำ, ขาว">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ขนาด/ไซส์</label>
                        <input type="text" class="form-input" id="productSize" placeholder="เช่น M, L, XL หรือขนาดเฉพาะ">
                    </div>

                    <div class="form-group">
                        <label class="form-label">น้ำหนัก (กรัม)</label>
                        <input type="number" class="form-input" id="productWeight" placeholder="0">
                    </div>
                </div>

                <!-- Pricing -->
                <div class="form-section">
                    <h3 class="form-section-title">ราคาและการจัดส่ง</h3>

                    <div class="form-group">
                        <label class="form-label">รูปแบบการขาย *</label>
                        <select class="form-input" id="listingType" required onchange="toggleAuctionFields()">
                            <option value="fixed">ราคาคงที่ (Buy It Now)</option>
                            <option value="auction">ประมูล (Auction)</option>
                            <option value="both">ทั้งสองแบบ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">สกุลเงิน *</label>
                        <select class="form-input" id="priceCurrency" required onchange="updateCurrencyLabel()">
                            <option value="THB">บาทไทย (THB)</option>
                            <option value="USD">ดอลลาร์สหรัฐ (USD)</option>
                            <option value="WLD">Worldcoin (WLD)</option>
                            <option value="EUR">ยูโร (EUR)</option>
                            <option value="JPY">เยน (JPY)</option>
                            <option value="GBP">ปอนด์ (GBP)</option>
                            <option value="CNY">หยวน (CNY)</option>
                            <option value="KRW">วอน (KRW)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ราคา *</label>
                        <div class="price-input-container">
                            <input type="number" class="form-input" id="productPrice" step="0.01" placeholder="0.00" required>
                            <span class="currency-label" id="currencyLabel">THB</span>
                        </div>
                        <small class="form-help">ราคาจะถูกแปลงเป็น WLD อัตโนมัติตามอัตราแลกเปลี่ยนปัจจุบัน</small>
                        <div id="wldConversion" class="form-help" style="color: #10b981; font-weight: 500; margin-top: 8px;">≈ 0.00 WLD</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ราคาเป็น WLD (แปลงอัตโนมัติ)</label>
                        <div class="price-input-container">
                            <input type="number" class="form-input" id="wldPriceField" step="0.0001" placeholder="0.0000" readonly style="background: rgba(15, 23, 42, 0.5); cursor: not-allowed;">
                            <span class="currency-label">WLD</span>
                        </div>
                        <small class="form-help" style="color: #10b981;">ราคานี้จะถูกคำนวณอัตโนมัติตามอัตราแลกเปลี่ยนที่เลือก</small>

                        <!-- Exchange Rate Lock Section -->
                        <div id="exchangeRateSection" class="form-group" style="background: rgba(15, 23, 42, 0.5); padding: 16px; border-radius: 8px; border-left: 4px solid #10b981; margin-top: 16px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label class="form-label" style="margin: 0; font-size: 14px;">อัตราแลกเปลี่ยน</label>
                                <span id="exchangeRateStatus" style="font-size: 12px; color: #a1a1aa;">กำลังโหลด...</span>
                            </div>
                            <div id="exchangeRateInfo" style="font-size: 14px; color: #f4f4f5; margin-bottom: 12px;">
                                1 <span id="currentCurrency">THB</span> = <span id="currentRate">0.003140</span> WLD
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" id="lockRateBtn" class="btn" style="flex: 1; padding: 8px 16px; font-size: 14px;">
                                    🔒 ล็อคอัตราแลกเปลี่ยน
                                </button>
                                <button type="button" id="refreshRateBtn" class="btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 14px;">
                                    🔄 รีเฟรชอัตรา
                                </button>
                            </div>
                            <div id="rateLockedInfo" style="display: none; margin-top: 12px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                                <div style="color: #10b981; font-weight: 500; font-size: 13px;">✓ อัตราแลกเปลี่ยนถูกล็อคแล้ว</div>
                                <div style="color: #a1a1aa; font-size: 12px;">ราคา WLD จะไม่เปลี่ยนแปลงจนกว่าจะยกเลิกการล็อค</div>
                            </div>
                        </div>
                    </div>

                    <div id="auctionFields" class="auction-fields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">ราคาเริ่มต้น</label>
                            <div class="price-input-container">
                                <input type="number" class="form-input" id="startingPrice" step="0.01" placeholder="0.00">
                                <span class="currency-label" id="auctionStartCurrencyLabel">THB</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ราคา Buy It Now</label>
                            <div class="price-input-container">
                                <input type="number" class="form-input" id="buyItNowPrice" step="0.01" placeholder="0.00">
                                <span class="currency-label" id="auctionBuyNowCurrencyLabel">THB</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ระยะเวลาประมูล</label>
                            <select class="form-input" id="auctionDuration">
                                <option value="1">1 วัน</option>
                                <option value="3">3 วัน</option>
                                <option value="5">5 วัน</option>
                                <option value="7">7 วัน</option>
                                <option value="10">10 วัน</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">จำนวน *</label>
                        <input type="number" class="form-input" id="productQuantity" min="1" value="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ค่าจัดส่ง (WLD)</label>
                        <select class="form-input" id="shippingType" onchange="toggleShippingPrice()">
                            <option value="free">จัดส่งฟรี</option>
                            <option value="flat">อัตราคงที่</option>
                            <option value="calculated">คำนวณตามระยะทาง</option>
                            <option value="pickup">รับสินค้าเอง</option>
                        </select>
                    </div>

                    <div class="form-group" id="shippingPriceGroup" style="display: none;">
                        <label class="form-label">ราคาค่าจัดส่ง</label>
                        <div class="price-input-container">
                            <input type="number" class="form-input" id="shippingPrice" step="0.01" placeholder="0.00">
                            <span class="currency-label" id="shippingCurrencyLabel">THB</span>
                        </div>
                    </div>
                </div>

                <!-- Location & Policies -->
                <div class="form-section">
                    <h3 class="form-section-title">ที่ตั้งและนโยบาย</h3>

                    <div class="form-group">
                        <label class="form-label">จังหวัด *</label>
                        <select class="form-input" id="productLocation" required>
                            <option value="">เลือกจังหวัด</option>
                            <option value="bangkok">กรุงเทพมหานคร</option>
                            <option value="chiangmai">เชียงใหม่</option>
                            <option value="phuket">ภูเก็ต</option>
                            <option value="chonburi">ชลบุรี</option>
                            <option value="nonthaburi">นนทบุรี</option>
                            <!-- เพิ่มจังหวัดอื่นๆ -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">เงื่อนไขการคืนสินค้า</label>
                        <select class="form-input" id="returnPolicy">
                            <option value="no-returns">ไม่รับคืน</option>
                            <option value="14-days">รับคืนภายใน 14 วัน</option>
                            <option value="30-days">รับคืนภายใน 30 วัน</option>
                            <option value="60-days">รับคืนภายใน 60 วัน</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ระยะเวลาในการจัดส่ง</label>
                        <select class="form-input" id="handlingTime">
                            <option value="1">1 วันทำการ</option>
                            <option value="2">2 วันทำการ</option>
                            <option value="3">3 วันทำการ</option>
                            <option value="5">5 วันทำการ</option>
                            <option value="7">7 วันทำการ</option>
                        </select>
                    </div>
                </div>

                <!-- Images -->
                <div class="form-section">
                    <h3 class="form-section-title">รูปภาพสินค้า</h3>

                    <div class="form-group">
                        <label class="form-label">อัปโหลดรูปภาพ (สูงสุด 12 รูป)</label>
                        <div class="image-upload-container">
                            <input type="file" id="productImages" accept="image/*" multiple style="display: none;">
                            <div class="image-upload-button" onclick="document.getElementById('productImages').click()">
                                <div class="upload-icon">📸</div>
                                <div>เลือกรูปภาพ</div>
                                <small>JPG, PNG ขนาดไม่เกิน 10MB ต่อรูป</small>
                            </div>
                        </div>
                        <small class="form-help">💡 คลิกที่ดาว (☆) เพื่อเลือกรูปหลักที่จะแสดงในหน้าตลาด</small>
                        <div id="imagePreview" class="image-preview-container"></div>
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="form-section">
                    <h3 class="form-section-title">ตัวเลือกเพิ่มเติม</h3>

                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="immediatePayment">
                            <span class="checkmark"></span>
                            ต้องการการชำระเงินทันที
                        </label>
                    </div>

                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="bestOffer">
                            <span class="checkmark"></span>
                            รับข้อเสนอราคา (Best Offer)
                        </label>
                    </div>

                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="privateAuction">
                            <span class="checkmark"></span>
                            ประมูลแบบส่วนตัว (ไม่แสดงชื่อผู้เสนอราคา)
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">บันทึกแบบร่าง</button>
                    <button type="button" class="btn-secondary" onclick="previewListing()">ดูตัวอย่าง</button>
                    <button type="submit" class="btn">✅ ลงขายสินค้า</button>
                </div>
            </form>
            </div>

            <!-- My Products Tab Content -->
            <div id="myProductsTabContent" class="tab-content" style="display: none;">
                <div id="myProductsList">
                    <!-- User's products will be loaded here -->
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
                        <div>กำลังโหลดสินค้าของคุณ...</div>
                    </div>
                </div>
            </div>

            <!-- Orders Tab Content -->
            <div id="ordersTabContent" class="tab-content" style="display: none;">
                <div class="product-card" style="margin-bottom: 16px;">
                    <div class="product-title">iPhone 14 Pro สีทอง</div>
                    <div class="product-price">570 WLD</div>
                    <div class="product-seller">สั่งซื้อจาก @alice_smith</div>
                    <div class="product-stats">
                        <span style="color: #10b981;">✅ เสร็จสิ้น</span>
                        <span>15 ก.ย. 2025</span>
                    </div>
                </div>

                <div class="product-card" style="margin-bottom: 16px;">
                    <div class="product-title">โต๊ะทำงาน IKEA</div>
                    <div class="product-price">90 WLD</div>
                    <div class="product-seller">ขายให้ @charlie_w</div>
                    <div class="product-stats">
                        <span style="color: #fbbf24;">🚚 กำลังจัดส่ง</span>
                        <span>18 ก.ย. 2025</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referrals Page -->
    <div id="referrals" class="page">
        <div class="container">
            <div class="header">
                <div class="logo">🤝 เครือข่าย</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">คนที่แนะนำ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">125.50</div>
                    <div class="stat-label">WLD ที่ได้รับ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">2,450</div>
                    <div class="stat-label">Finpoint (FP)</div>
                </div>
            </div>

            <!-- Referral Code Section -->
            <div class="referral-section">
                <h3 class="section-title">🎯 รหัสแนะนำของคุณ</h3>
                <div class="referral-code-card">
                    <div class="form-group">
                        <label class="form-label">รหัสแนะนำ</label>
                        <div class="referral-code-input">
                            <input type="text" id="myReferralCode" class="form-input" value="" readonly>
                            <button class="copy-code-btn" onclick="copyMyReferralCode()">📋</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ลิงค์แนะนำ</label>
                        <div class="referral-link-input">
                            <input type="text" id="myReferralLink" class="form-input" value="" readonly>
                            <button class="copy-link-btn" onclick="copyMyReferralLink()">🔗</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Who Invited You Section -->
            <div class="invited-users-section">
                <h3 class="section-title">🙋 ผู้ที่เชิญคุณมา</h3>
                <div id="myInviterInfo" class="invited-users-list">
                    <!-- Inviter info will be loaded dynamically -->
                </div>
            </div>

            <!-- Invited Users Section -->
            <div class="invited-users-section">
                <h3 class="section-title">👥 คนที่คุณชวนมา</h3>
                <div id="invitedUsersList" class="invited-users-list">
                    <!-- Users will be loaded dynamically -->
                </div>
            </div>

            <div class="referral-actions">
                <button class="btn" onclick="generateQRCode()">📱 สร้าง QR Code</button>
                <button class="btn-secondary" onclick="shareReferralLink()">📤 แชร์ลิงค์</button>
                <button class="btn-secondary" onclick="showReferralDetails()">📊 ดูรายละเอียด</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login" class="page">
        <div class="container">
            <div class="header">
                <div class="logo">🔐 เข้าสู่ระบบ</div>
            </div>

            <div class="auth-container">
                <div class="auth-form">
                    <div class="form-group">
                        <label class="form-label">Username หรือ Email</label>
                        <input type="text" id="loginUsername" class="auth-input" placeholder="กรอก username หรือ email">
                    </div>

                    <div class="form-group">
                        <label class="form-label">รหัสผ่าน</label>
                        <input type="password" id="loginPassword" class="auth-input" placeholder="กรอกรหัสผ่าน">
                    </div>

                    <button class="auth-btn primary" onclick="handleLogin()">เข้าสู่ระบบ</button>

                    <div class="auth-footer">
                        <p>ยังไม่มีบัญชี? <span class="auth-link" onclick="showPage('register')">สมัครสมาชิก</span></p>
                    </div>

                    <div class="demo-accounts">
                        <h4>🔧 บัญชีทดสอบ</h4>
                        <div class="demo-account" onclick="quickLogin('charlie_wilson', '123456')">
                            <span>👤 charlie_wilson</span>
                            <span>🔑 123456</span>
                        </div>
                        <div class="demo-account" onclick="quickLogin('alice_smith', '123456')">
                            <span>👤 alice_smith</span>
                            <span>🔑 123456</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="register" class="page">
        <div class="container">
            <div class="header">
                <div class="logo">📝 สมัครสมาชิก</div>
            </div>

            <div class="auth-container">
                <div class="auth-form">
                    <div class="form-group">
                        <label class="form-label">ชื่อ-นามสกุล *</label>
                        <input type="text" id="registerFullName" class="auth-input" placeholder="กรอกชื่อ-นามสกุล">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" id="registerUsername" class="auth-input" placeholder="กรอก username">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="registerEmail" class="auth-input" placeholder="กรอก email">
                    </div>

                    <div class="form-group">
                        <label class="form-label">รหัสผ่าน *</label>
                        <input type="password" id="registerPassword" class="auth-input" placeholder="กรอกรหัสผ่าน">
                    </div>

                    <div class="form-group">
                        <label class="form-label">เบอร์โทร</label>
                        <input type="tel" id="registerPhone" class="auth-input" placeholder="081-234-5678">
                    </div>

                    <div class="form-group">
                        <label class="form-label">จังหวัด</label>
                        <select id="registerProvince" class="auth-input">
                            <option value="">เลือกจังหวัด</option>
                            <option value="กรุงเทพมหานคร">กรุงเทพมหานคร</option>
                            <option value="กระบี่">กระบี่</option>
                            <option value="กาญจนบุรี">กาญจนบุรี</option>
                            <option value="กาฬสินธุ์">กาฬสินธุ์</option>
                            <option value="กำแพงเพชร">กำแพงเพชร</option>
                            <option value="ขอนแก่น">ขอนแก่น</option>
                            <option value="จันทบุรี">จันทบุรี</option>
                            <option value="ฉะเชิงเทรา">ฉะเชิงเทรา</option>
                            <option value="ชลบุรี">ชลบุรี</option>
                            <option value="ชัยนาท">ชัยนาท</option>
                            <option value="ชัยภูมิ">ชัยภูมิ</option>
                            <option value="ชุมพร">ชุมพร</option>
                            <option value="เชียงราย">เชียงราย</option>
                            <option value="เชียงใหม่">เชียงใหม่</option>
                            <option value="ตรัง">ตรัง</option>
                            <option value="ตราด">ตราด</option>
                            <option value="ตาก">ตาก</option>
                            <option value="นครนายก">นครนายก</option>
                            <option value="นครปฐม">นครปฐม</option>
                            <option value="นครพนม">นครพนม</option>
                            <option value="นครราชสีมา">นครราชสีมา</option>
                            <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                            <option value="นครสวรรค์">นครสวรรค์</option>
                            <option value="นนทบุรี">นนทบุรี</option>
                            <option value="นราธิวาส">นราธิวาส</option>
                            <option value="น่าน">น่าน</option>
                            <option value="บุรีรัมย์">บุรีรัมย์</option>
                            <option value="ปทุมธานี">ปทุมธานี</option>
                            <option value="ประจวบคีรีขันธ์">ประจวบคีรีขันธ์</option>
                            <option value="ปราจีนบุรี">ปราจีนบุรี</option>
                            <option value="ปัตตานี">ปัตตานี</option>
                            <option value="พระนครศรีอยุธยา">พระนครศรีอยุธยา</option>
                            <option value="พะเยา">พะเยา</option>
                            <option value="พังงา">พังงา</option>
                            <option value="พัทลุง">พัทลุง</option>
                            <option value="พิจิตร">พิจิตร</option>
                            <option value="พิษณุโลก">พิษณุโลก</option>
                            <option value="เพชรบุรี">เพชรบุรี</option>
                            <option value="เพชรบูรณ์">เพชรบูรณ์</option>
                            <option value="แพร่">แพร่</option>
                            <option value="ภูเก็ต">ภูเก็ต</option>
                            <option value="มหาสารคาม">มหาสารคาม</option>
                            <option value="มุกดาหาร">มุกดาหาร</option>
                            <option value="แม่ฮ่องสอน">แม่ฮ่องสอน</option>
                            <option value="ยโซธร">ยโซธร</option>
                            <option value="ยะลา">ยะลา</option>
                            <option value="ร้อยเอ็ด">ร้อยเอ็ด</option>
                            <option value="ระนอง">ระนอง</option>
                            <option value="ระยอง">ระยอง</option>
                            <option value="ราชบุรี">ราชบุรี</option>
                            <option value="ลพบุรี">ลพบุรี</option>
                            <option value="ลำปาง">ลำปาง</option>
                            <option value="ลำพูน">ลำพูน</option>
                            <option value="เลย">เลย</option>
                            <option value="ศรีสะเกษ">ศรีสะเกษ</option>
                            <option value="สกลนคร">สกลนคร</option>
                            <option value="สงขลา">สงขลา</option>
                            <option value="สตูล">สตูล</option>
                            <option value="สมุทรปราการ">สมุทรปราการ</option>
                            <option value="สมุทรสงคราม">สมุทรสงคราม</option>
                            <option value="สมุทรสาคร">สมุทรสาคร</option>
                            <option value="สระแก้ว">สระแก้ว</option>
                            <option value="สระบุรี">สระบุรี</option>
                            <option value="สิงห์บุรี">สิงห์บุรี</option>
                            <option value="สุโขทัย">สุโขทัย</option>
                            <option value="สุพรรณบุรี">สุพรรณบุรี</option>
                            <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                            <option value="สุรินทร์">สุรินทร์</option>
                            <option value="หนองคาย">หนองคาย</option>
                            <option value="หนองบัวลำภู">หนองบัวลำภู</option>
                            <option value="อ่างทอง">อ่างทอง</option>
                            <option value="อำนาจเจริญ">อำนาจเจริญ</option>
                            <option value="อุดรธานี">อุดรธานี</option>
                            <option value="อุตรดิตถ์">อุตรดิตถ์</option>
                            <option value="อุทัยธานี">อุทัยธานี</option>
                            <option value="อุบลราชธานี">อุบลราชธานี</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">รหัสแนะนำ (ถ้ามี)</label>
                        <div class="relative">
                            <input type="text" id="registerReferralCode" class="auth-input" placeholder="ใส่รหัสแนะนำ เช่น ALI001">
                            <button type="button" id="confirmReferralBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1 rounded text-sm transition-colors" style="display: none;">
                                🔍 ตรวจสอบ
                            </button>
                        </div>

                        <!-- Referrer Info Display (Hidden by default) -->
                        <div id="referrerInfo" class="mt-3" style="display: none;">
                            <div class="referrer-card" style="position: relative;">
                                <div class="referrer-info">
                                    <div class="referrer-avatar">
                                        <img id="referrerProfileImage" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                                        <div id="referrerAvatarFallback" style="width: 60px; height: 60px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center;">
                                            <span id="referrerAvatar" style="color: white; font-weight: bold; font-size: 20px;">?</span>
                                        </div>
                                    </div>
                                    <div class="referrer-details">
                                        <div class="referrer-name" id="referrerDisplayName">@username</div>
                                        <div class="referrer-code" style="color: #10b981;">ผู้แนะนำ</div>
                                        <div class="referrer-date" style="color: #10b981; font-size: 12px;">✓ รหัสแนะนำถูกต้อง</div>
                                    </div>
                                </div>
                                <button type="button" id="editReferralBtn" style="position: absolute; top: 8px; right: 8px; background: none; border: none; color: #10b981; text-decoration: underline; font-size: 12px; cursor: pointer;">
                                    แก้ไข
                                </button>
                            </div>
                        </div>

                        <!-- Edit Referral Code Confirmation (Hidden by default) -->
                        <div id="editReferralConfirm" class="mt-3 p-3 bg-yellow-900/30 border border-yellow-500/50 rounded-lg" style="display: none;">
                            <p class="text-yellow-300 text-sm mb-3">⚠️ คุณต้องการแก้ไขรหัสแนะนำหรือไม่?</p>
                            <div class="flex gap-2">
                                <button type="button" id="confirmEditBtn" class="text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" style="background-color: #059669 !important;">
                                    ยืนยัน
                                </button>
                                <button type="button" id="cancelEditBtn" class="text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" style="background-color: #ea580c !important;">
                                    ยกเลิก
                                </button>
                            </div>
                        </div>

                        <!-- No Referrer Found Options (Hidden by default) -->
                        <div id="noReferrerOptions" class="mt-3 p-3 bg-red-900/30 border border-red-500/50 rounded-lg" style="display: none;">
                            <p class="text-red-300 text-sm mb-3">❌ ไม่พบผู้แนะนำที่ใช้รหัส "<span id="invalidReferralCode"></span>"</p>
                            <p class="text-gray-300 text-sm mb-3">คุณต้องการให้ระบบจัดการอย่างไร?</p>
                            <div class="flex flex-col gap-2">
                                <button type="button" id="autoAssignBtn" class="text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors" style="background-color: #2563eb !important;">
                                    🤖 ให้ระบบจัดสรรผู้แนะนำให้อัตโนมัติ
                                </button>
                                <button type="button" id="retryReferralBtn" class="text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors" style="background-color: #ca8a04 !important;">
                                    ✏️ แก้ไขรหัสแนะนำใหม่
                                </button>
                            </div>
                        </div>
                    </div>

                    <button class="auth-btn primary" onclick="handleRegister()">สมัครสมาชิก</button>

                    <div class="auth-footer">
                        <p>มีบัญชีแล้ว? <span class="auth-link" onclick="showPage('login')">เข้าสู่ระบบ</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile" class="page">
        <div class="container">
            <div class="header">
                <div class="logo">👤 โปรไฟล์</div>
            </div>

            <!-- User Profile Header -->
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="position: relative; width: 100px; height: 100px; margin: 0 auto 16px;">
                    <div id="profileImage" style="width: 100px; height: 100px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; overflow: hidden;">👤</div>
                    <button class="edit-btn profile-image-edit" onclick="editProfileImage()" style="position: absolute; bottom: 0; right: 0; border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">📷</button>
                </div>
                <h2 id="profileUsername">@user_demo</h2>
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <p id="profileFullName" style="color: #94a3b8; font-size: 16px; margin: 4px 0;">Charlie Wilson</p>
                    <button class="edit-btn small" onclick="editFullName()">✏️</button>
                </div>
                <p id="profileRating" style="color: #a1a1aa;">⭐ 4.85 คะแนน</p>
            </div>

            <!-- Account Information Section -->
            <div class="profile-section">
                <h3 class="section-title">💼 ข้อมูลบัญชี</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">🆔 รหัสผู้ใช้:</span>
                        <span id="profileUserId" class="info-value">24GHI000003</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">📧 อีเมล:</span>
                        <span id="profileEmail" class="info-value">charlie@example.com</span>
                        <button class="edit-btn" onclick="editEmail()">✏️</button>
                    </div>
                    <div class="info-item">
                        <span class="info-label">📱 เบอร์โทร:</span>
                        <span id="profilePhone" class="info-value">081-234-5673</span>
                        <button class="edit-btn" onclick="editPhone()">✏️</button>
                    </div>
                    <div class="info-item">
                        <span class="info-label">🏠 ที่อยู่ในการส่งสินค้า:</span>
                        <span id="profileShippingAddress" class="info-value">321/12 หาดป่าตอง ตำบลป่าตอง อำเภอกะทู้ ภูเก็ต 83150</span>
                        <button class="edit-btn" onclick="editShippingAddress()">✏️</button>
                    </div>
                    <div class="info-item">
                        <span class="info-label">📅 สมัครเมื่อ:</span>
                        <span id="profileCreatedAt" class="info-value">1 ก.พ. 2567</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">🕐 เข้าใช้งานล่าสุด:</span>
                        <span id="profileLastLogin" class="info-value">19 ก.ย. 2567</span>
                    </div>
                </div>
            </div>

            <!-- Wallet Information Section -->
            <div class="profile-section">
                <h3 class="section-title">💰 กระเป๋าเงิน</h3>
                <div class="wallet-grid">
                    <div class="wallet-card">
                        <div class="wallet-icon">💵</div>
                        <div class="wallet-info">
                            <div class="wallet-label">ยอดเงิน THB</div>
                            <div id="profileThbBalance" class="wallet-value">฿32,150.75</div>
                        </div>
                    </div>
                    <div class="wallet-card">
                        <div class="wallet-icon">🌍</div>
                        <div class="wallet-info">
                            <div class="wallet-label">ยอดเงิน WLD</div>
                            <div id="profileWldBalance" class="wallet-value">89.5 WLD</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Statistics Section -->
            <div class="profile-section">
                <h3 class="section-title">📊 สถิติการขาย</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="profileTotalSales" class="stat-value">34</div>
                        <div class="stat-label">ขายแล้ว</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">8</div>
                        <div class="stat-label">ซื้อแล้ว</div>
                    </div>
                    <div class="stat-card">
                        <div id="profileSellerRating" class="stat-value">4.9</div>
                        <div class="stat-label">คะแนนผู้ขาย</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">942</div>
                        <div class="stat-label">ยอดดู</div>
                    </div>
                </div>
            </div>

            <!-- Referral System Section -->
            <div class="profile-section" id="referralSection" style="display: none;">
                <h3 class="section-title">👥 ผู้แนะนำ</h3>
                <div class="referrer-card">
                    <div class="referrer-info">
                        <div class="referrer-avatar">
                            <img id="referrerImage" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                        </div>
                        <div class="referrer-details">
                            <div class="referrer-name" id="referrerName"></div>
                            <div class="referrer-code" id="referrerCode"></div>
                            <div class="referrer-date" id="referrerDate"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="profile-section">
                <h3 class="section-title">⚙️ การตั้งค่า</h3>
                <div class="settings-grid">
                    <div class="setting-item clickable" onclick="toggleNotifications()">
                        <span class="setting-icon">🔔</span>
                        <span class="setting-label">การแจ้งเตือน</span>
                        <div id="notificationToggle" class="setting-toggle active">เปิด</div>
                    </div>
                    <div class="setting-item clickable" onclick="changeLanguage()">
                        <span class="setting-icon">🌍</span>
                        <span class="setting-label">ภาษา</span>
                        <div id="languageSetting" class="setting-value">ไทย</div>
                    </div>
                    <div class="setting-item clickable" onclick="changeCurrency()">
                        <span class="setting-icon">💱</span>
                        <span class="setting-label">สกุลเงินหลัก</span>
                        <div id="currencySetting" class="setting-value">THB</div>
                    </div>
                    <div class="setting-item clickable" onclick="toggleSecurity()">
                        <span class="setting-icon">🔒</span>
                        <span class="setting-label">การรักษาความปลอดภัย</span>
                        <div id="securityToggle" class="setting-toggle active">เปิด</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="profile-actions">
                <button class="btn-secondary" onclick="showWalletDetails()">💰 จัดการกระเป๋าเงิน</button>
                <button class="btn-secondary" onclick="showSettings()">⚙️ ตั้งค่าเพิ่มเติม</button>
                <button class="btn-secondary" onclick="contactSupport()">📞 ติดต่อเรา</button>
                <button class="btn-danger" onclick="logout()" style="margin-top: 16px;">🚪 ออกจากระบบ</button>
            </div>
        </div>
    </div>

    <!-- Chats List Page -->
    <div id="chatsList" class="page">
        <div class="container">
            <div class="header">
                <div class="logo">💬 แชท</div>
            </div>

            <div id="chatsListContainer">
                <!-- Chat list will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Chat Page -->
    <div id="chat" class="page">
        <div class="container">
            <div class="header">
                <button class="back-btn" onclick="goBackFromChat()">←</button>
                <div class="chat-header-info">
                    <img id="chatSellerAvatar" class="chat-avatar" src="" alt="Profile">
                    <div>
                        <div id="chatSellerName" class="chat-seller-name"></div>
                        <div id="chatProductName" class="chat-product-name"></div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be dynamically loaded here -->
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatMessageInput" class="chat-input" placeholder="พิมพ์ข้อความ..." maxlength="500">
                <button class="send-btn" onclick="sendMessage()">📤</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" onclick="showPage('marketplace')">
            <div class="icon">🏪</div>
            <div>ตลาด</div>
        </a>
        <a href="#" class="nav-item" onclick="showPage('listings')">
            <div class="icon">📋</div>
            <div>รายการ</div>
        </a>
        <a href="#" class="nav-item" onclick="showPage('chatsList')">
            <div class="icon">💬</div>
            <div>แชท</div>
        </a>
        <a href="#" class="nav-item" onclick="showPage('referrals')">
            <div class="icon">🤝</div>
            <div>เครือข่าย</div>
        </a>
        <a href="#" class="nav-item" onclick="showPage('profile')">
            <div class="icon">👤</div>
            <div>โปรไฟล์</div>
        </a>
    </div>

    <!-- Load API Client -->
    <script src="js/api-client.js"></script>

    <script>
        // Initialize Database (using API Client instead of MockDatabase)
        let database = null;
        let allProducts = [];
        let filteredProducts = [];
        let currentFilters = {
            search: '',
            category: '',
            condition: '',
            sort: 'newest',
            currency: 'WLD',
            minPrice: null,
            maxPrice: null
        };

        // Helper function to normalize users data to ensure it's always an Array
        function normalizeUsers(raw) {
            // Add debug logging for development
            if (typeof window !== 'undefined' && window.console) {
                console.debug('[Mobile] normalizeUsers input:', { raw, type: typeof raw, isArray: Array.isArray(raw) });
            }

            try {
                // If it's already an array, return as-is
                if (Array.isArray(raw)) {
                    return raw;
                }

                // If it's a string, try to parse as JSON
                if (typeof raw === 'string') {
                    const parsed = JSON.parse(raw);
                    return normalizeUsers(parsed); // Recursive call to handle nested cases
                }

                // If it's an object with users property, use that
                if (raw && typeof raw === 'object' && Array.isArray(raw.users)) {
                    return raw.users;
                }

                // If it's an object map, convert to array of values
                if (raw && typeof raw === 'object') {
                    const values = Object.values(raw);
                    // Check if values look like user objects
                    if (values.length > 0 && values[0] && typeof values[0] === 'object' && 'username' in values[0]) {
                        return values;
                    }
                }

                // Fallback: return empty array
                if (typeof window !== 'undefined' && window.console) {
                    console.warn('[Mobile] normalizeUsers fallback to empty array for:', raw);
                }
                return [];
            } catch (error) {
                if (typeof window !== 'undefined' && window.console) {
                    console.error('[Mobile] normalizeUsers error:', error, 'input:', raw);
                }
                return [];
            }
        }

        // Initialize database and load products
        async function initializeMarketplace() {
            try {
                // Initialize API Client
                database = new ApiClient();
                await database.initialize(); // Initialize and cache users
                console.log('✅ API Client initialized successfully');

                await loadProducts();
                console.log('✅ Marketplace initialized with', allProducts.length, 'products');
            } catch (error) {
                console.error('❌ Failed to initialize marketplace:', error);
                showError('ไม่สามารถโหลดข้อมูลสินค้าได้');
            }
        }

        // Load products from database
        async function loadProducts() {
            try {
                const response = await database.getProducts(1, 50); // Load first 50 products
                allProducts = response.data.filter(product => product.status === 'active');
                filteredProducts = [...allProducts];
                renderProducts();
                updateProductsCount();
            } catch (error) {
                console.error('Failed to load products:', error);
                showError('เกิดข้อผิดพลาดในการโหลดสินค้า');
            }
        }

        // Render products to the grid
        function renderProducts() {
            const productGrid = document.getElementById('productGrid');

            if (filteredProducts.length === 0) {
                productGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #a1a1aa;">
                        <div style="font-size: 24px; margin-bottom: 8px;">🔍</div>
                        <div>ไม่พบสินค้าที่ตรงกับเงื่อนไขการค้นหา</div>
                    </div>
                `;
                return;
            }

            productGrid.innerHTML = filteredProducts.map(product => {
                const seller = database.users.find(user => user.id === product.seller_id);
                const categoryIcon = getCategoryIcon(product.category);
                const conditionText = getConditionText(product.condition);
                const priceDisplay = formatPrice(product);

                const hasImages = product.images && product.images.length > 0;
                const firstImage = hasImages ? product.images[0] : null;

                return `
                    <div class="product-card" onclick="viewProduct(${product.id})">
                        <div class="product-image">
                            ${firstImage
                                ? `<img
                                    src="${firstImage}"
                                    alt="${product.title}"
                                    style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                    onerror="this.style.display='none'; this.parentElement.textContent='${categoryIcon} ${product.title.split(' ')[0]}'"
                                />`
                                : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #10b981; font-size: 24px;">${categoryIcon}</div>`
                            }
                        </div>
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">${priceDisplay}</div>
                        <div class="product-seller">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>@${seller?.username || 'unknown'}</span>
                                <div style="display: flex; align-items: center; font-size: 12px;">
                                    <span style="color: #fbbf24; margin-right: 2px;">${generateStarRating(seller?.seller_rating || 0)}</span>
                                    <span style="color: #6b7280;">(${(seller?.seller_rating || 0).toFixed(1)})</span>
                                </div>
                            </div>
                        </div>
                        <div class="product-stats">
                            <span>${conditionText}</span>
                            <button class="favorite-btn" onclick="toggleFavorite(event, ${product.id})">♡</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format price display (card view)
        function formatPrice(product) {
            if (product.price_currency === 'WLD') {
                // Convert WLD to THB for display (1 WLD ≈ 318 THB)
                const thbPrice = (product.price * 318).toLocaleString();
                return `฿${thbPrice} <small style="color: #a1a1aa;">(${product.price} WLD)</small>`;
            } else {
                const currencySymbol = getCurrencySymbol(product.price_currency);
                return `${currencySymbol}${product.price.toLocaleString()} <small style="color: #a1a1aa;">(${product.wld_price} WLD)</small>`;
            }
        }

        // Format price for popup (with dual currency display)
        function formatPriceForPopup(product) {
            if (product.price_currency === 'WLD') {
                // Convert WLD to THB for display (1 WLD ≈ 318 THB)
                const thbPrice = (product.price * 318).toLocaleString();
                return `฿${thbPrice} <span style="color: #10b981; font-weight: 500;">(${product.price} WLD)</span>`;
            } else {
                const currencySymbol = getCurrencySymbol(product.price_currency);
                return `${currencySymbol}${product.price.toLocaleString()} <span style="color: #10b981; font-weight: 500;">(${product.wld_price} WLD)</span>`;
            }
        }


        // Generate star rating display
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let starsHTML = '';

            // Full stars
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<span class="star">★</span>';
            }

            // Half star
            if (hasHalfStar) {
                starsHTML += '<span class="star">☆</span>';
            }

            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<span class="star empty">☆</span>';
            }

            return starsHTML;
        }

        // Get currency symbol
        function getCurrencySymbol(currency) {
            const symbols = {
                'THB': '฿',
                'USD': '$',
                'EUR': '€',
                'JPY': '¥',
                'GBP': '£',
                'CNY': '¥',
                'KRW': '₩'
            };
            return symbols[currency] || currency + ' ';
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'electronics': '📱',
                'gaming': '🎮',
                'camera': '📷',
                'fashion': '👕',
                'music': '🎵',
                'books': '📚',
                'home': '🏠',
                'sports': '⚽',
                'automotive': '🚗',
                'toys': '🎲',
                'beauty': '💄',
                'collectibles': '💎',
                'business': '💼'
            };
            return icons[category] || '📦';
        }

        // Get condition text
        function getConditionText(condition) {
            const conditions = {
                'new': 'ใหม่',
                'like-new': 'เหมือนใหม่',
                'excellent': 'ดีมาก',
                'good': 'ดี',
                'fair': 'ปานกลาง',
                'poor': 'เก่า'
            };
            return conditions[condition] || condition;
        }

        // Update products count
        function updateProductsCount() {
            const countElement = document.getElementById('productsCount');
            countElement.textContent = `${filteredProducts.length} รายการ`;
        }

        // Handle search
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            currentFilters.search = searchTerm;
            filterProducts();
        }

        // Filter products
        function filterProducts() {
            let filtered = [...allProducts];

            // Apply search filter
            if (currentFilters.search) {
                filtered = filtered.filter(product =>
                    product.title.toLowerCase().includes(currentFilters.search) ||
                    product.description.toLowerCase().includes(currentFilters.search)
                );
            }

            // Apply category filter
            if (currentFilters.category) {
                filtered = filtered.filter(product => product.category === currentFilters.category);
            }

            // Apply condition filter
            if (currentFilters.condition) {
                filtered = filtered.filter(product => product.condition === currentFilters.condition);
            }

            // Update filters from form
            currentFilters.category = document.getElementById('categoryFilter').value;
            currentFilters.condition = document.getElementById('conditionFilter').value;
            currentFilters.sort = document.getElementById('sortFilter').value;
            currentFilters.currency = document.getElementById('currencyFilter').value;

            // Update price filters from form
            const minPrice = parseFloat(document.getElementById('minPriceFilter').value);
            const maxPrice = parseFloat(document.getElementById('maxPriceFilter').value);
            currentFilters.minPrice = isNaN(minPrice) ? null : minPrice;
            currentFilters.maxPrice = isNaN(maxPrice) ? null : maxPrice;

            // Apply price range filter based on selected currency
            if (currentFilters.minPrice !== null || currentFilters.maxPrice !== null) {
                filtered = filtered.filter(product => {
                    let productPrice;

                    if (currentFilters.currency === 'WLD') {
                        // Always use WLD price for WLD filter
                        productPrice = product.wld_price;
                    } else if (currentFilters.currency === 'THB') {
                        // Use original THB price if available, otherwise convert from WLD
                        if (product.price_currency === 'THB') {
                            productPrice = product.price;
                        } else {
                            // Convert WLD to THB (approximate rate: 1 WLD ≈ 318 THB)
                            productPrice = product.wld_price * 318;
                        }
                    }

                    let passesMin = currentFilters.minPrice === null || productPrice >= currentFilters.minPrice;
                    let passesMax = currentFilters.maxPrice === null || productPrice <= currentFilters.maxPrice;

                    return passesMin && passesMax;
                });
            }

            // Apply sorting
            switch (currentFilters.sort) {
                case 'price-low':
                    filtered.sort((a, b) => a.wld_price - b.wld_price);
                    break;
                case 'price-high':
                    filtered.sort((a, b) => b.wld_price - a.wld_price);
                    break;
                case 'popular':
                    filtered.sort((a, b) => b.views - a.views);
                    break;
                case 'newest':
                default:
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }

            filteredProducts = filtered;
            renderProducts();
            updateProductsCount();
            updateSectionTitle();
        }

        // Format price number for display
        function formatPriceNumber(price) {
            if (currentFilters.currency === 'THB') {
                return parseFloat(price).toLocaleString('th-TH');
            } else {
                return parseFloat(price).toFixed(2);
            }
        }

        // Clear price filter
        function clearPriceFilter() {
            document.getElementById('minPriceFilter').value = '';
            document.getElementById('maxPriceFilter').value = '';
            document.getElementById('currencyFilter').value = 'WLD';
            currentFilters.minPrice = null;
            currentFilters.maxPrice = null;
            currentFilters.currency = 'WLD';
            filterProducts();
        }

        // Update section title based on filters
        function updateSectionTitle() {
            let title = 'สินค้าทั้งหมด';
            let titleParts = [];

            if (currentFilters.search) {
                title = `ผลการค้นหา: "${currentFilters.search}"`;
            } else if (currentFilters.category) {
                const categoryName = document.getElementById('categoryFilter').options[document.getElementById('categoryFilter').selectedIndex].text.split(' ')[1];
                titleParts.push(`หมวดหมู่: ${categoryName}`);
            }

            // Add price range to title
            if (currentFilters.minPrice !== null || currentFilters.maxPrice !== null) {
                const currencySymbol = currentFilters.currency === 'THB' ? '฿' : currentFilters.currency;
                let priceRange = '';

                if (currentFilters.minPrice !== null && currentFilters.maxPrice !== null) {
                    priceRange = `ราคา: ${formatPriceNumber(currentFilters.minPrice)}-${formatPriceNumber(currentFilters.maxPrice)} ${currencySymbol}`;
                } else if (currentFilters.minPrice !== null) {
                    priceRange = `ราคา: ${formatPriceNumber(currentFilters.minPrice)}+ ${currencySymbol}`;
                } else if (currentFilters.maxPrice !== null) {
                    priceRange = `ราคา: ≤${formatPriceNumber(currentFilters.maxPrice)} ${currencySymbol}`;
                }
                titleParts.push(priceRange);
            }

            if (titleParts.length > 0 && !currentFilters.search) {
                title = titleParts.join(' • ');
            }

            document.getElementById('productsSectionTitle').textContent = title;
        }

        // View product details
        function viewProduct(productId) {
            console.log('View product:', productId);
            // TODO: Navigate to product detail page
            alert(`ดูรายละเอียดสินค้า ID: ${productId} (กำลังพัฒนา)`);
        }

        // Toggle favorite
        function toggleFavorite(event, productId) {
            event.stopPropagation();
            const btn = event.target;
            btn.classList.toggle('active');
            btn.textContent = btn.classList.contains('active') ? '♥' : '♡';
            console.log('Toggle favorite for product:', productId);
        }

        // Show error message
        function showError(message) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ef4444;">
                    <div style="font-size: 24px; margin-bottom: 8px;">⚠️</div>
                    <div>${message}</div>
                </div>
            `;
        }

        // Listings Tab Management
        function showListingsTab(tabName) {
            // Hide all tab contents
            document.getElementById('sellTabContent').style.display = 'none';
            document.getElementById('myProductsTabContent').style.display = 'none';
            document.getElementById('ordersTabContent').style.display = 'none';

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.style.color = '#9ca3af';
                btn.style.borderBottom = 'none';
            });

            // Show selected tab content and activate button
            if (tabName === 'sell') {
                document.getElementById('sellTabContent').style.display = 'block';
                document.getElementById('sellTab').style.color = '#10b981';
                document.getElementById('sellTab').style.borderBottom = '2px solid #10b981';
            } else if (tabName === 'myProducts') {
                document.getElementById('myProductsTabContent').style.display = 'block';
                document.getElementById('myProductsTab').style.color = '#10b981';
                document.getElementById('myProductsTab').style.borderBottom = '2px solid #10b981';
                // Load user's products
                loadMyProducts();
            } else if (tabName === 'orders') {
                document.getElementById('ordersTabContent').style.display = 'block';
                document.getElementById('ordersTab').style.color = '#10b981';
                document.getElementById('ordersTab').style.borderBottom = '2px solid #10b981';
                // Load user's orders
                loadMyOrders();
            }
        }

        function loadMyProducts() {
            const content = document.getElementById('myProductsTabContent');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

            if (!currentUser.id) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔒</div>
                        <div>กรุณาเข้าสู่ระบบเพื่อดูสินค้าของคุณ</div>
                    </div>
                `;
                return;
            }

            try {
                // Get products from localStorage
                const products = JSON.parse(localStorage.getItem('fingrow_products') || '[]');
                const myProducts = products.filter(product => parseInt(product.seller_id) === parseInt(currentUser.id));

                if (myProducts.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
                            <div>คุณยังไม่มีสินค้าลงขาย</div>
                            <div style="margin-top: 16px; color: #6b7280;">คลิกแท็บ "ลงขาย" เพื่อเริ่มขายสินค้า</div>
                        </div>
                    `;
                } else {
                    let productsHTML = '';
                    myProducts.forEach(product => {
                        const status = product.status === 'active' ?
                            '<span style="color: #10b981;">✅ กำลังขาย</span>' :
                            '<span style="color: #9ca3af;">⏸️ หยุดขาย</span>';

                        // Generate random view count for demonstration (or use actual data if available)
                        const viewCount = product.view_count || Math.floor(Math.random() * 50) + 1;

                        productsHTML += `
                            <div class="product-card" onclick="viewProduct(${product.id})">
                                <div class="product-image" style="position: relative;">
                                    <img
                                        src="${product.images ? product.images[0] : ''}"
                                        alt="${product.title}"
                                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                        onerror="this.style.display='none'; this.parentElement.textContent='📦 ${product.title.split(' ')[0]}'"
                                    />
                                    <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        👁️ ${viewCount}
                                    </div>
                                    <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${status}
                                    </div>
                                </div>
                                <div class="product-title">${product.title}</div>
                                <div class="product-price">${product.price} WLD</div>
                                <div class="product-seller">ขายโดยคุณ</div>
                                <div class="product-stats">
                                    <span>ลงขาย ${new Date(product.created_at || Date.now()).toLocaleDateString('th-TH')}</span>
                                    <button class="favorite-btn" onclick="editProduct(event, ${product.id})" style="background: #374151; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px;">แก้ไข</button>
                                </div>
                            </div>
                        `;
                    });

                    content.innerHTML = `
                        <div style="margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-weight: 600; color: #374151;">สินค้าของฉัน (${myProducts.length} รายการ)</div>
                        </div>
                        <div class="product-grid">
                            ${productsHTML}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading my products:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                        <div>เกิดข้อผิดพลาดในการโหลดสินค้า</div>
                    </div>
                `;
            }
        }

        function loadMyOrders() {
            // Placeholder - load current user's orders
            const content = document.getElementById('ordersTabContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
                    <div>กำลังโหลดคำสั่งซื้อของคุณ...</div>
                </div>
            `;
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected page
            document.getElementById(pageId).classList.add('active');

            // Special handling for listings page
            if (pageId === 'listings') {
                // Always show sell tab by default
                setTimeout(() => showListingsTab('sell'), 10);
            }

            // Special handling for referrals/network page
            if (pageId === 'referrals') {
                loadReferralsData();
            }

            // Legacy redirect handling
            if (pageId === 'create' || pageId === 'orders') {
                // Redirect old pages to new listings page
                showPage('listings');
                return;
            }

            // Add active to clicked nav item
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // Load data for marketplace page
            if (pageId === 'marketplace' && database && allProducts.length === 0) {
                loadProducts();
            }
            // Load data for chats list page
            if (pageId === 'chatsList' && database) {
                loadChatsList();
            }
            // Load data for profile page
            if (pageId === 'profile' && database) {
                loadProfileData();
            }
        }

        // Handle favorite buttons
        document.querySelectorAll('.favorite-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                this.textContent = this.classList.contains('active') ? '♥' : '♡';
            });
        });

        // Real-time WLD price update
        async function loadWLDPrice() {
            try {
                const priceElement = document.getElementById('wldPriceMobile');
                const timeElement = document.getElementById('lastUpdated');

                if (!priceElement) return;

                // Fetch WLD price from CoinGecko API with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=worldcoin-wld&vs_currencies=usd,thb&include_24hr_change=true', {
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const wldData = data['worldcoin-wld'];

                if (wldData) {
                    const thbPrice = wldData.thb;
                    const change24h = wldData.usd_24h_change || 0;

                    // Update price display
                    priceElement.textContent = `1 WLD = ฿${thbPrice.toFixed(2)}`;

                    // Update timestamp
                    const now = new Date();
                    if (timeElement) {
                        const timeStr = now.toLocaleTimeString('th-TH', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const changeIcon = change24h >= 0 ? '↗' : '↘';
                        const changeColor = change24h >= 0 ? '#10b981' : '#ef4444';
                        timeElement.innerHTML = `<span style="color: ${changeColor}">${changeIcon}${Math.abs(change24h).toFixed(2)}%</span> • ${timeStr}`;
                    }

                    console.log('WLD Price updated (Mobile):', { thbPrice, change24h });
                } else {
                    throw new Error('WLD data not available');
                }
            } catch (error) {
                console.error('Error loading WLD price (Mobile):', error);
                const priceElement = document.getElementById('wldPriceMobile');
                const timeElement = document.getElementById('lastUpdated');

                if (priceElement) {
                    priceElement.textContent = '1 WLD = ฿--';
                }
                if (timeElement) {
                    timeElement.textContent = 'Price unavailable';
                }
            }
        }

        // Initial load and periodic updates
        loadWLDPrice();
        loadExchangeRates();
        setInterval(loadWLDPrice, 300000); // Update every 5 minutes
        setInterval(loadExchangeRates, 300000); // Update exchange rates every 5 minutes

        // Initialize exchange rate section
        setTimeout(() => {
            const initialCurrency = document.getElementById('priceCurrency').value;
            updateExchangeRateSection(initialCurrency);
        }, 100);

        // Exchange Rates (will be updated from API)
        let exchangeRates = {
            THB: { toWLD: 1/318.5, name: 'บาทไทย' },
            USD: { toWLD: 1/1.85, name: 'ดอลลาร์สหรัฐ' },
            WLD: { toWLD: 1, name: 'Worldcoin' },
            EUR: { toWLD: 1/1.68, name: 'ยูโร' },
            JPY: { toWLD: 1/275.2, name: 'เยน' },
            GBP: { toWLD: 1/1.45, name: 'ปอนด์' },
            CNY: { toWLD: 1/13.2, name: 'หยวน' },
            KRW: { toWLD: 1/2485, name: 'วอน' }
        };

        // Rate lock state
        let lockedRate = null;
        let lockedCurrency = null;
        let rateLockedAt = null;

        // Currency conversion function
        function convertToWLD(amount, currency) {
            // Use locked rate if available and currency matches
            if (lockedRate && lockedCurrency === currency) {
                return amount * lockedRate;
            }
            // Otherwise use current exchange rate
            return amount * exchangeRates[currency].toWLD;
        }

        // Update currency labels and conversion
        function updateCurrencyLabel() {
            const selectedCurrency = document.getElementById('priceCurrency').value;
            document.getElementById('currencyLabel').textContent = selectedCurrency;
            document.getElementById('auctionStartCurrencyLabel').textContent = selectedCurrency;
            document.getElementById('auctionBuyNowCurrencyLabel').textContent = selectedCurrency;
            document.getElementById('shippingCurrencyLabel').textContent = selectedCurrency;

            // Update exchange rate section
            updateExchangeRateSection(selectedCurrency);

            // Update WLD conversion
            updatePriceConversion();
        }

        // Update exchange rate section
        function updateExchangeRateSection(currency) {
            const exchangeRateSection = document.getElementById('exchangeRateSection');
            const currentCurrencyEl = document.getElementById('currentCurrency');
            const currentRateEl = document.getElementById('currentRate');
            const wldPriceField = document.getElementById('wldPriceField');

            if (currency === 'WLD') {
                exchangeRateSection.style.display = 'none';
                // If currency is WLD, set WLD field to same as price field
                const price = parseFloat(document.getElementById('productPrice').value) || 0;
                if (wldPriceField) {
                    wldPriceField.value = price.toFixed(4);
                }
                return;
            }

            exchangeRateSection.style.display = 'block';
            currentCurrencyEl.textContent = currency;

            const currentRate = lockedRate && lockedCurrency === currency ? lockedRate : exchangeRates[currency]?.toWLD;
            currentRateEl.textContent = currentRate ? currentRate.toFixed(6) : '0.000000';

            // Update status
            updateRateStatus();
        }

        // Update rate status display
        function updateRateStatus() {
            const statusEl = document.getElementById('exchangeRateStatus');
            const currency = document.getElementById('priceCurrency').value;

            if (lockedRate && lockedCurrency === currency) {
                statusEl.textContent = `ล็อคแล้ว (${new Date(rateLockedAt).toLocaleTimeString('th-TH')})`;
                statusEl.style.color = '#10b981';
                document.getElementById('rateLockedInfo').style.display = 'block';
                document.getElementById('lockRateBtn').textContent = '🔓 ยกเลิกล็อค';
            } else {
                statusEl.textContent = 'อัตราปัจจุบัน';
                statusEl.style.color = '#a1a1aa';
                document.getElementById('rateLockedInfo').style.display = 'none';
                document.getElementById('lockRateBtn').textContent = '🔒 ล็อคอัตราแลกเปลี่ยน';
            }
        }

        // Update WLD price conversion display
        function updatePriceConversion() {
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const currency = document.getElementById('priceCurrency').value;
            const wldPrice = convertToWLD(price, currency);

            // Update conversion display (≈)
            const conversionElement = document.getElementById('wldConversion');
            if (price > 0) {
                const lockStatus = lockedRate && lockedCurrency === currency ? ' (ล็อค)' : '';
                conversionElement.textContent = `≈ ${wldPrice.toFixed(4)} WLD${lockStatus}`;
                conversionElement.style.display = 'block';
            } else {
                conversionElement.textContent = '≈ 0.00 WLD';
                conversionElement.style.display = 'block';
            }

            // Update WLD price field
            const wldPriceField = document.getElementById('wldPriceField');
            if (wldPriceField) {
                wldPriceField.value = price > 0 ? wldPrice.toFixed(4) : '0.0000';
            }
        }

        // Load exchange rates from API
        async function loadExchangeRates() {
            try {
                // Get WLD price in various currencies
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=worldcoin-wld&vs_currencies=thb,usd,eur,gbp,jpy,cny,krw', {
                    signal: AbortSignal.timeout(10000)
                });

                if (response.ok) {
                    const data = await response.json();
                    const wldRates = data['worldcoin-wld'];

                    if (wldRates) {
                        // Update exchange rates (1 unit of currency = X WLD)
                        exchangeRates = {
                            THB: { toWLD: 1/wldRates.thb, name: 'บาทไทย' },
                            USD: { toWLD: 1/wldRates.usd, name: 'ดอลลาร์สหรัฐ' },
                            WLD: { toWLD: 1, name: 'Worldcoin' },
                            EUR: { toWLD: 1/wldRates.eur, name: 'ยูโร' },
                            GBP: { toWLD: 1/wldRates.gbp, name: 'ปอนด์' },
                            JPY: { toWLD: 1/wldRates.jpy, name: 'เยน' },
                            CNY: { toWLD: 1/wldRates.cny, name: 'หยวน' },
                            KRW: { toWLD: 1/wldRates.krw, name: 'วอน' }
                        };
                        console.log('Exchange rates updated:', exchangeRates);

                        // Update display if not locked
                        const currency = document.getElementById('priceCurrency')?.value;
                        if (currency && (!lockedCurrency || lockedCurrency !== currency)) {
                            updateExchangeRateSection(currency);
                            updatePriceConversion();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load exchange rates:', error);
                // Use default rates if API fails
            }
        }

        // Lock current exchange rate
        function lockExchangeRate() {
            const currency = document.getElementById('priceCurrency').value;

            if (lockedRate && lockedCurrency === currency) {
                // Unlock rate
                lockedRate = null;
                lockedCurrency = null;
                rateLockedAt = null;
                console.log('Exchange rate unlocked');
            } else {
                // Lock current rate
                lockedRate = exchangeRates[currency]?.toWLD;
                lockedCurrency = currency;
                rateLockedAt = new Date().toISOString();
                console.log(`Exchange rate locked: 1 ${currency} = ${lockedRate.toFixed(6)} WLD`);
            }

            updateRateStatus();
            updatePriceConversion();
        }

        // Refresh exchange rate (force update)
        async function refreshExchangeRate() {
            document.getElementById('exchangeRateStatus').textContent = 'กำลังอัพเดท...';
            document.getElementById('exchangeRateStatus').style.color = '#fbbf24';

            await loadExchangeRates();

            const currency = document.getElementById('priceCurrency').value;
            updateExchangeRateSection(currency);
            updatePriceConversion();
        }

        // Create Listing Form Functions
        function updateSubCategories() {
            const category = document.getElementById('productCategory').value;
            const subCategorySelect = document.getElementById('productSubCategory');

            // Clear existing options
            subCategorySelect.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย</option>';

            const subCategories = {
                electronics: [
                    { value: 'smartphones', text: 'โทรศัพท์มือถือ' },
                    { value: 'laptops', text: 'แล็ปท็อป' },
                    { value: 'tablets', text: 'แท็บเล็ต' },
                    { value: 'cameras', text: 'กล้องถ่ายรูป' },
                    { value: 'audio', text: 'อุปกรณ์เสียง' },
                    { value: 'gaming', text: 'เกมมิ่ง' },
                    { value: 'smart-home', text: 'Smart Home' },
                    { value: 'accessories', text: 'อุปกรณ์เสริม' }
                ],
                fashion: [
                    { value: 'mens-clothing', text: 'เสื้อผ้าผู้ชาย' },
                    { value: 'womens-clothing', text: 'เสื้อผ้าผู้หญิง' },
                    { value: 'shoes', text: 'รองเท้า' },
                    { value: 'bags', text: 'กระเป๋า' },
                    { value: 'watches', text: 'นาฬิกา' },
                    { value: 'jewelry', text: 'เครื่องประดับ' },
                    { value: 'kids-clothing', text: 'เสื้อผ้าเด็ก' }
                ],
                home: [
                    { value: 'furniture', text: 'เฟอร์นิเจอร์' },
                    { value: 'appliances', text: 'เครื่องใช้ไฟฟ้า' },
                    { value: 'kitchenware', text: 'อุปกรณ์ครัว' },
                    { value: 'bedding', text: 'ที่นอนและเครื่องนอน' },
                    { value: 'decor', text: 'ของตกแต่ง' },
                    { value: 'garden', text: 'สวนและระเบียง' }
                ],
                sports: [
                    { value: 'fitness', text: 'ออกกำลังกาย' },
                    { value: 'outdoor', text: 'กิจกรรมกลางแจ้ง' },
                    { value: 'team-sports', text: 'กีฬาประเภททีม' },
                    { value: 'water-sports', text: 'กีฬาทางน้ำ' },
                    { value: 'winter-sports', text: 'กีฬาฤดูหนาว' }
                ],
                automotive: [
                    { value: 'car-parts', text: 'อะไหล่รถยนต์' },
                    { value: 'motorcycle-parts', text: 'อะไหล่มอเตอร์ไซค์' },
                    { value: 'car-accessories', text: 'อุปกรณ์เสริมรถยนต์' },
                    { value: 'tools', text: 'เครื่องมือซ่อม' }
                ],
                books: [
                    { value: 'textbooks', text: 'หนังสือเรียน' },
                    { value: 'fiction', text: 'นิยาย' },
                    { value: 'non-fiction', text: 'สารคดี' },
                    { value: 'comics', text: 'การ์ตูน/มังงะ' },
                    { value: 'magazines', text: 'นิตยสาร' }
                ],
                toys: [
                    { value: 'action-figures', text: 'ฟิกเกอร์/โมเดล' },
                    { value: 'board-games', text: 'เกมกระดาน' },
                    { value: 'educational', text: 'ของเล่นเพื่อการศึกษา' },
                    { value: 'stuffed-animals', text: 'ตุ๊กตา' },
                    { value: 'puzzles', text: 'จิ๊กซอว์' }
                ],
                beauty: [
                    { value: 'skincare', text: 'ผลิตภัณฑ์บำรุงผิว' },
                    { value: 'makeup', text: 'เครื่องสำอาง' },
                    { value: 'fragrances', text: 'น้ำหอม' },
                    { value: 'hair-care', text: 'บำรุงเส้นผม' },
                    { value: 'health', text: 'สุขภาพ' }
                ],
                collectibles: [
                    { value: 'coins', text: 'เหรียญสะสม' },
                    { value: 'stamps', text: 'แสตมป์' },
                    { value: 'vintage', text: 'ของโบราณ' },
                    { value: 'art', text: 'งานศิลปะ' },
                    { value: 'memorabilia', text: 'ของที่ระลึก' }
                ],
                business: [
                    { value: 'office-supplies', text: 'อุปกรณ์สำนักงาน' },
                    { value: 'machinery', text: 'เครื่องจักร' },
                    { value: 'restaurant', text: 'อุปกรณ์ร้านอาหาร' },
                    { value: 'retail', text: 'อุปกรณ์ค้าปลีก' }
                ]
            };

            if (subCategories[category]) {
                subCategories[category].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.value;
                    option.textContent = sub.text;
                    subCategorySelect.appendChild(option);
                });
            }
        }

        function toggleAuctionFields() {
            const listingType = document.getElementById('listingType').value;
            const auctionFields = document.getElementById('auctionFields');

            if (listingType === 'auction' || listingType === 'both') {
                auctionFields.style.display = 'block';
            } else {
                auctionFields.style.display = 'none';
            }
        }

        function toggleShippingPrice() {
            const shippingType = document.getElementById('shippingType').value;
            const shippingPriceGroup = document.getElementById('shippingPriceGroup');

            if (shippingType === 'flat' || shippingType === 'calculated') {
                shippingPriceGroup.style.display = 'block';
            } else {
                shippingPriceGroup.style.display = 'none';
            }
        }

        // Image handling
        let primaryImageIndex = 0; // Track which image is the primary

        document.getElementById('productImages').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const previewContainer = document.getElementById('imagePreview');

            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imagePreview = document.createElement('div');
                        const currentImageIndex = previewContainer.children.length;
                        imagePreview.className = 'image-preview';
                        imagePreview.dataset.imageIndex = currentImageIndex;

                        const isPrimary = currentImageIndex === primaryImageIndex;
                        imagePreview.innerHTML = `
                            <img src="${e.target.result}" alt="Product image ${currentImageIndex + 1}">
                            <button type="button" class="image-preview-remove" onclick="removeImage(this)">×</button>
                            <button type="button" class="image-preview-primary ${isPrimary ? 'active' : ''}"
                                    onclick="setPrimaryImage(${currentImageIndex})"
                                    title="ตั้งเป็นรูปหลัก">
                                ${isPrimary ? '⭐' : '☆'}
                            </button>
                            ${isPrimary ? '<div class="primary-badge">รูปหลัก</div>' : ''}
                        `;
                        previewContainer.appendChild(imagePreview);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function setPrimaryImage(imageIndex) {
            primaryImageIndex = imageIndex;

            // Update all image previews to show correct primary status
            const previews = document.querySelectorAll('.image-preview');
            previews.forEach((preview, index) => {
                const primaryButton = preview.querySelector('.image-preview-primary');
                const badge = preview.querySelector('.primary-badge');

                if (index === imageIndex) {
                    // Set as primary
                    primaryButton.classList.add('active');
                    primaryButton.innerHTML = '⭐';
                    if (!badge) {
                        const badgeElement = document.createElement('div');
                        badgeElement.className = 'primary-badge';
                        badgeElement.textContent = 'รูปหลัก';
                        preview.appendChild(badgeElement);
                    }
                } else {
                    // Remove primary status
                    primaryButton.classList.remove('active');
                    primaryButton.innerHTML = '☆';
                    if (badge) {
                        badge.remove();
                    }
                }
            });
        }

        function removeImage(button) {
            const imagePreview = button.parentElement;
            const imageIndex = parseInt(imagePreview.dataset.imageIndex);

            // If removing primary image, set first image as primary
            if (imageIndex === primaryImageIndex && document.querySelectorAll('.image-preview').length > 1) {
                primaryImageIndex = 0;
                // Re-index after removal
                setTimeout(() => {
                    const previews = document.querySelectorAll('.image-preview');
                    previews.forEach((preview, index) => {
                        preview.dataset.imageIndex = index;
                    });
                    if (previews.length > 0) {
                        setPrimaryImage(0);
                    }
                }, 10);
            }

            imagePreview.remove();
        }

        function saveDraft() {
            console.log('Saving draft...');
            // TODO: Implement save draft functionality
            alert('บันทึกแบบร่างเรียบร้อยแล้ว!');
        }

        function previewListing() {
            console.log('Previewing listing...');
            // TODO: Implement preview functionality
            alert('ฟีเจอร์ดูตัวอย่างกำลังพัฒนา...');
        }

        // Real-time price conversion
        document.getElementById('productPrice').addEventListener('input', updatePriceConversion);
        document.getElementById('priceCurrency').addEventListener('change', updatePriceConversion);

        // Exchange rate lock buttons
        document.getElementById('lockRateBtn').addEventListener('click', lockExchangeRate);
        document.getElementById('refreshRateBtn').addEventListener('click', refreshExchangeRate);

        // Form submission
        document.getElementById('createListingForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Collect form data
            const selectedCurrency = document.getElementById('priceCurrency').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const wldPriceFromField = parseFloat(document.getElementById('wldPriceField').value);
            const wldPrice = convertToWLD(price, selectedCurrency);

            // Get conversion rate used for this transaction
            const usedConversionRate = lockedRate && lockedCurrency === selectedCurrency ? lockedRate : exchangeRates[selectedCurrency]?.toWLD;

            const formData = {
                title: document.getElementById('productTitle').value,
                category: document.getElementById('productCategory').value,
                subCategory: document.getElementById('productSubCategory').value,
                brand: document.getElementById('productBrand').value,
                model: document.getElementById('productModel').value,
                condition: document.getElementById('productCondition').value,
                description: document.getElementById('productDescription').value,
                color: document.getElementById('productColor').value,
                size: document.getElementById('productSize').value,
                weight: document.getElementById('productWeight').value,
                listingType: document.getElementById('listingType').value,
                price: price,
                priceCurrency: selectedCurrency,
                wldPrice: wldPriceFromField || wldPrice.toFixed(4),
                wldPriceCalculated: wldPrice.toFixed(4),
                // Transaction conversion rate data
                conversionRate: usedConversionRate,
                rateLockedAt: lockedRate && lockedCurrency === selectedCurrency ? rateLockedAt : new Date().toISOString(),
                rateSource: lockedRate && lockedCurrency === selectedCurrency ? 'locked' : 'current',
                quantity: document.getElementById('productQuantity').value,
                shippingType: document.getElementById('shippingType').value,
                shippingPrice: document.getElementById('shippingPrice').value,
                shippingCurrency: selectedCurrency,
                location: document.getElementById('productLocation').value,
                returnPolicy: document.getElementById('returnPolicy').value,
                handlingTime: document.getElementById('handlingTime').value,
                immediatePayment: document.getElementById('immediatePayment').checked,
                bestOffer: document.getElementById('bestOffer').checked,
                privateAuction: document.getElementById('privateAuction').checked
            };

            // If auction type, get auction-specific data
            if (formData.listingType === 'auction' || formData.listingType === 'both') {
                const startingPrice = parseFloat(document.getElementById('startingPrice').value) || 0;
                const buyItNowPrice = parseFloat(document.getElementById('buyItNowPrice').value) || 0;

                formData.startingPrice = startingPrice;
                formData.startingPriceWLD = convertToWLD(startingPrice, selectedCurrency).toFixed(4);
                formData.buyItNowPrice = buyItNowPrice;
                formData.buyItNowPriceWLD = convertToWLD(buyItNowPrice, selectedCurrency).toFixed(4);
                formData.auctionDuration = document.getElementById('auctionDuration').value;
            }

            console.log('Creating listing with data:', formData);

            // TODO: Submit to backend API
            alert('ลงขายสินค้าเรียบร้อยแล้ว! (Demo)');

            // Reset form
            document.getElementById('createListingForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
        });

        console.log('🌱 Fingrow Mobile App Loaded');
        console.log('📱 Features: Marketplace, Create Listing, Orders, Referrals, Profile');
        console.log('🎯 Status: Demo Version - Ready for Development');
        console.log('✨ Enhanced Create Listing Form with eBay-style fields');
        console.log('💱 Multi-Currency Support: THB, USD, WLD, EUR, JPY, GBP, CNY, KRW');
        console.log('🔄 Real-time Exchange Rate Conversion to WLD');
        console.log('🔒 Exchange Rate Lock Feature with Transaction Rate Recording');
        console.log('💰 Dedicated WLD Price Field with Auto-Conversion');

        // Initialize app with authentication check
        async function initializeApp() {
            try {
                await initializeMarketplace();

                // Check for referral code in URL
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(window.location.hash.indexOf('?') + 1));
                const referralCode = urlParams.get('ref') || hashParams.get('ref');

                if (referralCode) {
                    console.log('🔗 Referral code detected:', referralCode);
                    // Store referral code for registration
                    sessionStorage.setItem('referralCode', referralCode);
                    // Show register page if not logged in
                    if (!checkAuthStatus()) {
                        showPage('register');
                        // Pre-fill referral code and check referrer info
                        setTimeout(async () => {
                            const referralInput = document.getElementById('registerReferralCode');
                            if (referralInput) {
                                referralInput.value = referralCode;
                                await checkReferralCode(referralCode);
                            }
                        }, 100);
                        return;
                    }
                }

                // Check if user is already logged in
                if (!checkAuthStatus()) {
                    showPage('login');
                } else {
                    showPage('marketplace');
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                showPage('login');
            }
        }

        // Initialize app when page loads
        initializeApp();

        // Product popup functions
        let currentProductImages = [];
        let currentImageIndex = 0;
        let currentProduct = null;

        function viewProduct(productId) {
            currentProduct = allProducts.find(p => p.id === productId);
            if (!currentProduct) return;

            const seller = database.users.find(user => user.id === currentProduct.seller_id);

            // Set product details
            document.getElementById('productDetailTitle').textContent = currentProduct.title;
            document.getElementById('productDetailPrice').innerHTML = formatPriceForPopup(currentProduct);
            document.getElementById('sellerProvince').textContent = seller?.province || 'ไม่ระบุจังหวัด';

            document.getElementById('productDetailDescription').textContent = currentProduct.description || 'ไม่มีคำอธิบาย';
            document.getElementById('productDetailCondition').textContent = getConditionText(currentProduct.condition);
            document.getElementById('productDetailCategory').textContent = getCategoryText(currentProduct.category);
            document.getElementById('productDetailViews').textContent = `${currentProduct.views} ครั้ง`;

            // Set seller info
            document.getElementById('sellerProfileImage').src = seller?.profile_image || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face';
            document.getElementById('sellerName').textContent = `@${seller?.username || 'unknown'}`;

            // Set seller rating
            const rating = seller?.seller_rating || 0;
            document.getElementById('sellerRatingStars').innerHTML = generateStarRating(rating);
            document.getElementById('sellerRatingText').textContent = rating.toFixed(1);
            document.getElementById('sellerSalesCount').textContent = seller?.total_sales || 0;

            document.getElementById('sellerJoinDate').textContent = seller?.created_at || 'ไม่ทราบ';
            document.getElementById('sellerStatus').textContent = seller?.status === 'active' ? 'ออนไลน์' : 'ออฟไลน์';

            // Set up image gallery
            currentProductImages = currentProduct.images || [];
            currentImageIndex = 0;
            setupImageGallery();

            // Show popup
            document.getElementById('productPopup').classList.add('show');
        }

        function closeProductPopup() {
            document.getElementById('productPopup').classList.remove('show');
            currentProduct = null;
            currentProductImages = [];
            currentImageIndex = 0;
        }

        function setupImageGallery() {
            const mainImage = document.getElementById('productMainImage');
            const indicators = document.getElementById('imageIndicators');
            const prevBtn = document.getElementById('imagePrevBtn');
            const nextBtn = document.getElementById('imageNextBtn');

            if (currentProductImages.length === 0) return;

            // Set main image
            mainImage.src = currentProductImages[currentImageIndex];

            // Create indicators
            indicators.innerHTML = currentProductImages.map((_, index) =>
                `<div class="image-dot ${index === currentImageIndex ? 'active' : ''}"
                      onclick="changeProductImage(${index})"></div>`
            ).join('');

            // Update navigation buttons
            if (currentProductImages.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';

                // Disable/enable buttons based on current index
                prevBtn.classList.toggle('disabled', currentImageIndex === 0);
                nextBtn.classList.toggle('disabled', currentImageIndex === currentProductImages.length - 1);
            }
        }

        function changeProductImage(index) {
            if (index < 0 || index >= currentProductImages.length) return;
            currentImageIndex = index;
            setupImageGallery();
        }

        function prevProductImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                setupImageGallery();
            }
        }

        function nextProductImage() {
            if (currentImageIndex < currentProductImages.length - 1) {
                currentImageIndex++;
                setupImageGallery();
            }
        }

        // Chat global variables
        let currentChatProduct = null;
        let currentChatSeller = null;
        let chatMessages = [];

        function contactSeller() {
            if (!currentProduct) {
                alert('ไม่มีข้อมูลสินค้า');
                return;
            }

            const seller = database.users.find(user => user.id === currentProduct.seller_id);
            if (!seller) {
                alert('ไม่พบข้อมูลผู้ขาย');
                return;
            }

            // Set current chat data
            currentChatProduct = currentProduct;
            currentChatSeller = seller;

            // Close product detail popup
            closeProductPopup();

            // Load chat messages
            loadChatMessages();

            // Show chat page
            showPage('chat');
        }

        function loadChatMessages() {
            if (!currentChatProduct || !currentChatSeller) return;

            // Get messages between current user (assume user_id = 1 for demo) and seller for this product
            const currentUserId = 1; // In real app, get from auth
            chatMessages = database.chat_messages.filter(msg =>
                msg.product_id === currentChatProduct.id &&
                ((msg.sender_id === currentUserId && msg.receiver_id === currentChatSeller.id) ||
                 (msg.sender_id === currentChatSeller.id && msg.receiver_id === currentUserId))
            );

            // Sort messages by created_at
            chatMessages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            // Update chat header
            document.getElementById('chatSellerAvatar').src = currentChatSeller.profile_image;
            document.getElementById('chatSellerName').textContent = `@${currentChatSeller.username}`;
            document.getElementById('chatProductName').textContent = currentChatProduct.title;

            // Render messages
            renderChatMessages();
        }

        function renderChatMessages() {
            const chatMessagesContainer = document.getElementById('chatMessages');
            const currentUserId = 1; // In real app, get from auth

            chatMessagesContainer.innerHTML = '';

            chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender_id === currentUserId ? 'sent' : 'received'}`;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                bubbleDiv.textContent = msg.message;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = formatMessageTime(msg.created_at);

                messageDiv.appendChild(bubbleDiv);
                messageDiv.appendChild(timeDiv);
                chatMessagesContainer.appendChild(messageDiv);
            });

            // Scroll to bottom
            setTimeout(() => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }, 100);
        }

        function formatMessageTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'เมื่อกี้';
            if (diffMins < 60) return `${diffMins} นาทีที่แล้ว`;
            if (diffHours < 24) return `${diffHours} ชั่วโมงที่แล้ว`;
            if (diffDays < 7) return `${diffDays} วันที่แล้ว`;

            return date.toLocaleDateString('th-TH', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('chatMessageInput');
            const messageText = messageInput.value.trim();

            if (!messageText || !currentChatProduct || !currentChatSeller) return;

            const currentUserId = 1; // In real app, get from auth
            const newMessage = {
                id: database.chat_messages.length + 1,
                sender_id: currentUserId,
                receiver_id: currentChatSeller.id,
                product_id: currentChatProduct.id,
                message: messageText,
                type: 'text',
                created_at: new Date().toISOString().replace('T', ' ').substring(0, 19),
                read_at: null
            };

            // Add to database
            database.chat_messages.push(newMessage);

            // Add to current chat
            chatMessages.push(newMessage);

            // Clear input
            messageInput.value = '';

            // Re-render messages
            renderChatMessages();
        }

        function goBackFromChat() {
            // Clear chat data
            currentChatProduct = null;
            currentChatSeller = null;
            chatMessages = [];

            // Go back to chat list
            showPage('chatsList');
        }

        // Chat List Functions
        function loadChatsList() {
            const currentUserId = 1; // In real app, get from auth
            const chatsContainer = document.getElementById('chatsListContainer');

            // Get all unique chat conversations for current user
            const userChats = new Map();

            database.chat_messages.forEach(msg => {
                let otherUserId, product;

                if (msg.sender_id === currentUserId) {
                    otherUserId = msg.receiver_id;
                } else if (msg.receiver_id === currentUserId) {
                    otherUserId = msg.sender_id;
                } else {
                    return; // Message not involving current user
                }

                product = database.products.find(p => p.id === msg.product_id);
                const otherUser = database.users.find(u => u.id === otherUserId);

                if (!otherUser || !product) return;

                const chatKey = `${msg.product_id}_${otherUserId}`;

                if (!userChats.has(chatKey) || new Date(msg.created_at) > new Date(userChats.get(chatKey).lastMessage.created_at)) {
                    userChats.set(chatKey, {
                        otherUser,
                        product,
                        lastMessage: msg,
                        unreadCount: 0 // TODO: Calculate actual unread count
                    });
                }
            });

            // Convert to array and sort by latest message
            const chatsList = Array.from(userChats.values()).sort((a, b) =>
                new Date(b.lastMessage.created_at) - new Date(a.lastMessage.created_at)
            );

            // Render chat list
            if (chatsList.length === 0) {
                chatsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a1a1aa;">
                        <div style="font-size: 64px; margin-bottom: 16px;">💬</div>
                        <h3>ยังไม่มีแชท</h3>
                        <p>เริ่มสนทนากับผู้ขายในหน้าสินค้า</p>
                    </div>
                `;
            } else {
                chatsContainer.innerHTML = chatsList.map(chat => `
                    <div class="chat-list-item" onclick="openChatFromList('${chat.product.id}', '${chat.otherUser.id}')">
                        <img class="chat-list-avatar" src="${chat.otherUser.profile_image}" alt="Profile">
                        <div class="chat-list-info">
                            <div class="chat-list-header">
                                <div class="chat-list-name">@${chat.otherUser.username}</div>
                                <div class="chat-list-time">${formatMessageTime(chat.lastMessage.created_at)}</div>
                                ${chat.unreadCount > 0 ? `<div class="unread-badge">${chat.unreadCount}</div>` : ''}
                            </div>
                            <div class="chat-list-preview">${chat.lastMessage.message}</div>
                            <div class="chat-list-product">เรื่อง: ${chat.product.title}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function openChatFromList(productId, sellerId) {
            // Find product and seller
            currentChatProduct = database.products.find(p => p.id == productId);
            currentChatSeller = database.users.find(u => u.id == sellerId);

            if (!currentChatProduct || !currentChatSeller) {
                alert('ไม่พบข้อมูลแชท');
                return;
            }

            // Load chat messages
            loadChatMessages();

            // Show chat page
            showPage('chat');
        }

        // Add Enter key support for sending messages
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatMessageInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });

        function buyProduct() {
            if (!currentProduct) return;
            alert(`สั่งซื้อสินค้า: ${currentProduct.title} (ฟีเจอร์นี้ยังไม่พร้อม)`);
            console.log('Buy product:', currentProduct.id);
        }

        function getCategoryText(category) {
            const categoryMap = {
                'electronics': '🔌 อิเล็กทรอนิกส์',
                'gaming': '🎮 เกมมิ่ง',
                'fashion': '👕 แฟชั่น',
                'camera': '📷 กล้อง',
                'music': '🎵 ดนตรี'
            };
            return categoryMap[category] || category;
        }

        // Close popup when clicking outside
        const productPopup = document.getElementById('productPopup');
        if (productPopup) {
            productPopup.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProductPopup();
                }
            });
        }

        // Keyboard navigation for image gallery
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('productPopup').classList.contains('show')) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    prevProductImage();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextProductImage();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeProductPopup();
                }
            }
        });

        // Touch/swipe support for image gallery
        let touchStartX = 0;
        let touchEndX = 0;

        const productMainImage = document.getElementById('productMainImage');
        if (productMainImage) {
            productMainImage.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            });

            productMainImage.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
        }

        function handleSwipe() {
            const swipeThreshold = 50; // Minimum swipe distance
            const swipeDistance = touchEndX - touchStartX;

            if (Math.abs(swipeDistance) > swipeThreshold) {
                if (swipeDistance > 0) {
                    // Swipe right - show previous image
                    prevProductImage();
                } else {
                    // Swipe left - show next image
                    nextProductImage();
                }
            }
        }

        // Profile Management Functions
        var currentUser = null;

        // Helper function to format user address from structured fields
        function formatUserAddress(user) {
            console.log('formatUserAddress called with user:', user);

            if (!user.address_number && !user.address_street) {
                console.log('No structured address fields, using shipping_address:', user.shipping_address);
                return user.shipping_address || '';
            }

            const parts = [
                user.address_number,
                user.address_street,
                user.address_subdistrict ? `แขวง${user.address_subdistrict}` : '',
                user.address_district ? `เขต${user.address_district}` : '',
                user.address_province,
                user.address_postal_code
            ].filter(part => part && part.trim()); // Remove empty parts

            const result = parts.join(' ');
            console.log('Formatted address parts:', parts);
            console.log('Final formatted address:', result);
            return result;
        }

        // ฟังก์ชันอัพเดทข้อมูลผู้ใช้ในฐานข้อมูล
        function updateUserInDatabase(user) {
            try {
                console.log('Updating user in database:', user);
                database.updateUser(user.id, user);
                // Also update localStorage
                localStorage.setItem('currentUser', JSON.stringify(user));
                console.log('User updated successfully');
            } catch (error) {
                console.error('Error updating user:', error);
                alert('❌ เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        }

        // ฟังก์ชันอัปโหลดรูปโปรไฟล์ไปเซิร์ฟเวอร์
        async function uploadProfileImageToServer(file, userId) {
            try {
                // สร้าง FormData สำหรับส่งไฟล์
                const formData = new FormData();
                formData.append('profileImage', file);
                formData.append('userId', userId);

                console.log('Uploading profile image to server...');

                // ส่งคำขออัปโหลดไฟล์
                const response = await fetch('/api/upload-profile-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Profile image uploaded successfully:', result.data);

                    // อัปเดตรูปโปรไฟล์ในหน้าเว็บ
                    const imageUrl = result.data.path;
                    document.getElementById('profileImage').innerHTML =
                        '<img src="' + imageUrl + '" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">';

                    // อัปเดตข้อมูลผู้ใช้ใน localStorage
                    if (currentUser) {
                        currentUser.profile_image = imageUrl;
                        currentUser.avatar_url = imageUrl;
                        currentUser.profile_image_filename = result.data.filename;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }

                    alert('✅ เปลี่ยนรูปโปรไฟล์สำเร็จ!\n\nชื่อไฟล์: ' + result.data.filename + '\nขนาดไฟล์: ' + Math.round(file.size / 1024) + ' KB');
                } else {
                    console.error('Upload failed:', result.message);
                    alert('❌ อัปโหลดรูปโปรไฟล์ไม่สำเร็จ\n' + result.message);
                }
            } catch (error) {
                console.error('Error uploading profile image:', error);
                alert('❌ เกิดข้อผิดพลาดในการอัปโหลดรูปโปรไฟล์\nกรุณาลองใหม่');
            }
        }

        // Authentication Functions
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                alert('❌ กรุณากรอก username และรหัสผ่าน');
                return;
            }


            // Clear any old localStorage data that might interfere
            console.log('[Debug] Clearing localStorage...');
            localStorage.clear();

            // Ensure database is initialized
            if (!database) {
                database = new ApiClient();
                await database.initialize(); // Initialize users cache
                console.log('⚠️ Database initialized in handleLogin');
            }

            console.log('[Debug] Login data:', { username, password: '***' });

            try {
                const result = await database.login({ username, password });

                if (result.success) {
                    // Ensure user has all structured address fields from database
                    if (database.users && database.users.length > 0) {
                        try {
                            const normalizedUsers = normalizeUsers(database.users || []);
                            const fullUser = normalizedUsers.find(u => u.id === result.user.id);
                            if (fullUser) {
                                // Check if structured fields exist, if not migrate from shipping_address
                                if (!fullUser.address_number && fullUser.shipping_address) {
                                    console.log('🔄 Migrating legacy address to structured fields for user:', fullUser.username);
                                    // Parse legacy address for fallback
                                    const address = fullUser.shipping_address;
                                    const parts = address.split(' ');
                                    fullUser.address_number = parts[0] || '';
                                    fullUser.address_street = parts.slice(1, 3).join(' ') || '';
                                    fullUser.address_subdistrict = parts.find(p => p.includes('แขวง'))?.replace('แขวง', '') || '';
                                    fullUser.address_district = parts.find(p => p.includes('เขต'))?.replace('เขต', '') || '';
                                    fullUser.address_province = parts.find(p => ['กรุงเทพมหานคร', 'ภูเก็ต', 'เชียงใหม่', 'เชียงราย'].includes(p)) || '';
                                    fullUser.address_postal_code = parts.find(p => /^\d{5}$/.test(p)) || '';
                                    // Update database with structured fields
                                    database.updateUser(fullUser.id, fullUser);
                                }

                                currentUser = fullUser;
                                localStorage.setItem('currentUser', JSON.stringify(fullUser));
                                console.log('🔍 Login - Full user data loaded:', currentUser);
                            } else {
                                currentUser = result.user;
                                localStorage.setItem('currentUser', JSON.stringify(result.user));
                            }
                        } catch (error) {
                            console.error('Error loading full user data:', error);
                            currentUser = result.user;
                            localStorage.setItem('currentUser', JSON.stringify(result.user));
                        }
                    } else {
                        currentUser = result.user;
                        localStorage.setItem('currentUser', JSON.stringify(result.user));
                    }

                    alert(`✅ เข้าสู่ระบบสำเร็จ!\nยินดีต้อนรับ ${result.user.full_name}`);

                    // Redirect to marketplace
                    showPage('marketplace');
                } else {
                    console.log('❌ Login failed:', result.message);
                    alert(`❌ เข้าสู่ระบบไม่สำเร็จ\n${result.message}`);
                }
            } catch (error) {
                console.error('❌ Login error:', error);
                alert('❌ เกิดข้อผิดพลาดในการเข้าสู่ระบบ');
            }
        }

        // Function to check and display referral code information
        async function checkReferralCode(code, showNoReferrerOptions = false) {
            if (!code || code.trim() === '') {
                hideAllReferralElements();
                return;
            }

            try {
                console.log('[Mobile] Checking referral code:', code);
                const users = await database.getUsers(1, 1000);
                const referrer = users.data.find(u => u.referral_code === code.trim());

                if (referrer) {
                    console.log('[Mobile] Found referrer:', referrer);
                    hideAllReferralElements();
                    showReferrerInfo(referrer);
                } else {
                    console.log('[Mobile] Referral code not found');
                    hideAllReferralElements();
                    if (showNoReferrerOptions) {
                        showNoReferrerOptions(code.trim());
                    }
                }
            } catch (error) {
                console.error('[Mobile] Error checking referral code:', error);
                hideAllReferralElements();
            }
        }

        // Function to get random active user for auto-assign
        async function getRandomInvitor() {
            try {
                const users = await database.getUsers(1, 1000);
                const activeUsers = users.data.filter(u => u.status === 'active' && u.referral_code);
                if (activeUsers.length > 0) {
                    const randomIndex = Math.floor(Math.random() * activeUsers.length);
                    return activeUsers[randomIndex];
                }
                return null;
            } catch (error) {
                console.error('[Mobile] Error getting random invitor:', error);
                return null;
            }
        }

        // Function to show referrer information
        function showReferrerInfo(referrer) {
            const referrerInfo = document.getElementById('referrerInfo');
            const referrerDisplayName = document.getElementById('referrerDisplayName');
            const referrerAvatar = document.getElementById('referrerAvatar');
            const referrerProfileImage = document.getElementById('referrerProfileImage');
            const referrerAvatarFallback = document.getElementById('referrerAvatarFallback');
            const referralInput = document.getElementById('registerReferralCode');

            if (referrerInfo && referrerDisplayName && referrerAvatar) {
                referrerDisplayName.textContent = `@${referrer.username}`;
                referrerAvatar.textContent = referrer.username.charAt(0).toUpperCase();

                // Show profile image if available, otherwise show fallback
                if (referrer.profile_image && referrerProfileImage && referrerAvatarFallback) {
                    referrerProfileImage.src = referrer.profile_image;
                    referrerProfileImage.style.display = 'block';
                    referrerAvatarFallback.style.display = 'none';
                } else if (referrerAvatarFallback) {
                    referrerAvatarFallback.style.display = 'flex';
                    if (referrerProfileImage) referrerProfileImage.style.display = 'none';
                }

                referrerInfo.style.display = 'block';

                // Make referral code input readonly and hide confirm button
                if (referralInput) {
                    referralInput.readOnly = true;
                    referralInput.style.backgroundColor = 'rgba(15, 23, 42, 0.5)';
                    referralInput.style.cursor = 'not-allowed';
                }

                hideConfirmButton();
            }
        }

        // Function to hide all referral-related elements
        function hideAllReferralElements() {
            const referrerInfo = document.getElementById('referrerInfo');
            const editReferralConfirm = document.getElementById('editReferralConfirm');
            const noReferrerOptions = document.getElementById('noReferrerOptions');

            if (referrerInfo) referrerInfo.style.display = 'none';
            if (editReferralConfirm) editReferralConfirm.style.display = 'none';
            if (noReferrerOptions) noReferrerOptions.style.display = 'none';
        }

        // Function to show edit confirmation
        function showEditConfirmation() {
            hideAllReferralElements();
            const editReferralConfirm = document.getElementById('editReferralConfirm');
            if (editReferralConfirm) {
                editReferralConfirm.style.display = 'block';
            }
        }

        // Function to show no referrer options
        function showNoReferrerOptions(invalidCode) {
            const noReferrerOptions = document.getElementById('noReferrerOptions');
            const invalidReferralCode = document.getElementById('invalidReferralCode');

            if (noReferrerOptions) {
                noReferrerOptions.style.display = 'block';
            }

            if (invalidReferralCode) {
                invalidReferralCode.textContent = invalidCode;
            }
        }

        // Function to enable referral input editing
        function enableReferralEdit() {
            const referralInput = document.getElementById('registerReferralCode');
            const confirmReferralBtn = document.getElementById('confirmReferralBtn');

            if (referralInput) {
                referralInput.readOnly = false;
                referralInput.style.backgroundColor = '';
                referralInput.style.cursor = '';
                referralInput.focus();
                referralInput.select();
            }

            // Show confirm button
            if (confirmReferralBtn) {
                confirmReferralBtn.style.display = 'block';
            }
        }

        // Function to hide confirm button
        function hideConfirmButton() {
            const confirmReferralBtn = document.getElementById('confirmReferralBtn');
            if (confirmReferralBtn) {
                confirmReferralBtn.style.display = 'none';
            }
        }

        // Initialize referral code checking on input change
        document.addEventListener('DOMContentLoaded', function() {
            const referralInput = document.getElementById('registerReferralCode');
            const editReferralBtn = document.getElementById('editReferralBtn');
            const confirmEditBtn = document.getElementById('confirmEditBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const confirmReferralBtn = document.getElementById('confirmReferralBtn');
            const autoAssignBtn = document.getElementById('autoAssignBtn');
            const retryReferralBtn = document.getElementById('retryReferralBtn');

            let isEditMode = false; // Flag to prevent auto-check during edit

            if (referralInput) {
                // Debounced input checking
                let timeout;
                referralInput.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        if (!this.readOnly && !isEditMode) {
                            checkReferralCode(this.value, true);
                        }
                    }, 500);
                });

                // Clear edit mode when user starts typing
                referralInput.addEventListener('keydown', function() {
                    if (isEditMode) {
                        isEditMode = false;
                    }
                });
            }

            if (editReferralBtn) {
                editReferralBtn.addEventListener('click', function() {
                    showEditConfirmation();
                });
            }

            if (confirmEditBtn) {
                confirmEditBtn.addEventListener('click', function() {
                    isEditMode = true; // Set edit mode flag
                    hideAllReferralElements();
                    enableReferralEdit();
                    // Don't check current value to allow editing
                    // User will trigger check when they type
                });
            }

            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    hideAllReferralElements();
                    // Re-show referrer info if there was one
                    const currentValue = referralInput ? referralInput.value : '';
                    if (currentValue) {
                        checkReferralCode(currentValue, false);
                    }
                });
            }

            if (autoAssignBtn) {
                autoAssignBtn.addEventListener('click', async function() {
                    this.disabled = true;
                    this.innerHTML = '🔄 กำลังค้นหาผู้แนะนำ...';

                    const randomInvitor = await getRandomInvitor();
                    if (randomInvitor) {
                        if (referralInput) {
                            referralInput.value = randomInvitor.referral_code;
                        }
                        hideAllReferralElements();
                        showReferrerInfo(randomInvitor);
                        alert(`✅ ระบบได้จัดสรร @${randomInvitor.username} เป็นผู้แนะนำให้คุณแล้ว`);
                    } else {
                        alert('❌ ไม่สามารถหาผู้แนะนำได้ในขณะนี้');
                    }

                    this.disabled = false;
                    this.innerHTML = '🤖 ให้ระบบจัดสรรผู้แนะนำให้อัตโนมัติ';
                });
            }


            if (retryReferralBtn) {
                retryReferralBtn.addEventListener('click', function() {
                    isEditMode = true; // Set edit mode flag
                    hideAllReferralElements();
                    enableReferralEdit();
                });
            }

            if (confirmReferralBtn) {
                confirmReferralBtn.addEventListener('click', async function() {
                    const currentCode = referralInput ? referralInput.value.trim() : '';

                    if (!currentCode) {
                        hideAllReferralElements();
                        hideConfirmButton();
                        return;
                    }

                    // Disable button during check
                    this.disabled = true;
                    this.innerHTML = '🔄 ตรวจสอบ...';

                    try {
                        console.log('[Mobile] Confirming referral code:', currentCode);
                        const users = await database.getUsers(1, 1000);
                        const referrer = users.data.find(u => u.referral_code === currentCode);

                        if (referrer) {
                            console.log('[Mobile] Found referrer:', referrer);
                            hideAllReferralElements();
                            hideConfirmButton();
                            showReferrerInfo(referrer);
                            isEditMode = false;
                        } else {
                            console.log('[Mobile] Referral code not found');
                            hideAllReferralElements();
                            showNoReferrerOptions(currentCode);
                        }
                    } catch (error) {
                        console.error('[Mobile] Error confirming referral code:', error);
                        alert('❌ เกิดข้อผิดพลาดในการตรวจสอบรหัสแนะนำ');
                    }

                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '🔍 ตรวจสอบ';
                });
            }
        });

        async function handleRegister() {
            const fullName = document.getElementById('registerFullName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const province = document.getElementById('registerProvince').value;
            const referralCode = document.getElementById('registerReferralCode').value.trim();

            // Validation
            if (!fullName || !username || !email || !password) {
                alert('❌ กรุณากรอกข้อมูลที่จำเป็น (มี * )');
                return;
            }

            if (password.length < 6) {
                alert('❌ รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            if (!email.includes('@')) {
                alert('❌ รูปแบบอีเมลไม่ถูกต้อง');
                return;
            }

            const userData = {
                full_name: fullName,
                username: username,
                email: email,
                password: password,
                phone: phone,
                province: province,
                referral_code: referralCode
            };

            // Debug logging
            console.log('[Mobile] Registering user with data:', userData);
            console.log('[Mobile] Referral code being sent:', referralCode);

            // Ensure database is initialized
            if (!database) {
                database = new ApiClient();
                console.log('⚠️ Database initialized in handleRegister');
            }

            try {
                const result = await database.register(userData);

                if (result.success) {
                    alert(`✅ สมัครสมาชิกสำเร็จ!\nยินดีต้อนรับ ${result.user.full_name}\nรหัสแนะนำของคุณ: ${result.user.referral_code}`);

                    // Auto login after registration
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    currentUser = result.user;
                    showPage('marketplace');
                } else {
                    alert(`❌ สมัครสมาชิกไม่สำเร็จ\n${result.message}`);
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('❌ เกิดข้อผิดพลาดในการสมัครสมาชิก');
            }
        }

        function quickLogin(username, password) {
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = password;
            handleLogin();
        }

        function logout() {
            if (confirm('ต้องการออกจากระบบหรือไม่?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showPage('login');
                alert('✅ ออกจากระบบเรียบร้อยแล้ว');
            }
        }

        // Session Management
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const parsedUser = JSON.parse(savedUser);
                // Refresh user data from database to get latest structured fields
                if (database && typeof database.getUsers === 'function') {
                    try {
                        const rawUsers = database.getUsers();
                        const users = normalizeUsers(rawUsers);
                        const fullUser = users.find(u => u.id === parsedUser.id);
                        if (fullUser) {
                            // Check if structured fields exist, if not migrate from shipping_address
                            if (!fullUser.address_number && fullUser.shipping_address) {
                                console.log('🔄 Migrating legacy address to structured fields for user:', fullUser.username);
                                // Parse legacy address for fallback
                                const address = fullUser.shipping_address;
                                const parts = address.split(' ');
                                fullUser.address_number = parts[0] || '';
                                fullUser.address_street = parts.slice(1, 3).join(' ') || '';
                                fullUser.address_subdistrict = parts.find(p => p.includes('แขวง'))?.replace('แขวง', '') || '';
                                fullUser.address_district = parts.find(p => p.includes('เขต'))?.replace('เขต', '') || '';
                                fullUser.address_province = parts.find(p => ['กรุงเทพมหานคร', 'ภูเก็ต', 'เชียงใหม่', 'เชียงราย'].includes(p)) || '';
                                fullUser.address_postal_code = parts.find(p => /^\d{5}$/.test(p)) || '';
                                // Update database with structured fields
                                database.updateUser(fullUser.id, fullUser);
                            }

                            currentUser = fullUser;
                            localStorage.setItem('currentUser', JSON.stringify(fullUser));
                            console.log('🔍 Refreshed user data from database:', currentUser);
                        } else {
                            currentUser = parsedUser;
                        }
                    } catch (error) {
                        console.error('Error refreshing user data:', error);
                        currentUser = parsedUser;
                    }
                } else {
                    currentUser = parsedUser;
                }
                return true;
            }
            return false;
        }

        function requireAuth() {
            if (!checkAuthStatus()) {
                showPage('login');
                return false;
            }
            return true;
        }

        function loadProfileData() {
            // Use current logged in user
            if (!currentUser) {
                console.error('❌ No user logged in!');
                return;
            }

            console.log('🔍 Debug currentUser:', currentUser);
            console.log('🔍 Profile image:', currentUser.profile_image);
            console.log('🔍 Address fields debug:', {
                address_number: currentUser.address_number,
                address_street: currentUser.address_street,
                address_subdistrict: currentUser.address_subdistrict,
                address_district: currentUser.address_district,
                address_province: currentUser.address_province,
                address_postal_code: currentUser.address_postal_code,
                shipping_address: currentUser.shipping_address
            });

            if (currentUser) {
                // Update profile image
                const profileImage = document.getElementById('profileImage');
                if (currentUser.profile_image) {
                    profileImage.innerHTML = `<img src="${currentUser.profile_image}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                }

                // Update basic profile info
                const profileUsername = document.getElementById('profileUsername');
                if (profileUsername) {
                    profileUsername.textContent = `@${currentUser.username}`;
                }
                const profileFullName = document.getElementById('profileFullName');
                if (profileFullName) {
                    profileFullName.textContent = currentUser.full_name;
                }
                const profileRating = document.getElementById('profileRating');
                if (profileRating) {
                    profileRating.textContent = `⭐ ${currentUser.seller_rating} คะแนน`;
                }

                // Update account information
                const profileUserId = document.getElementById('profileUserId');
                if (profileUserId) {
                    profileUserId.textContent = currentUser.auto_user_id;
                }
                const profileEmail = document.getElementById('profileEmail');
                if (profileEmail) {
                    profileEmail.textContent = currentUser.email;
                }
                const profilePhone = document.getElementById('profilePhone');
                if (profilePhone) {
                    profilePhone.textContent = currentUser.phone;
                }
                const profileShippingAddress = document.getElementById('profileShippingAddress');
                if (profileShippingAddress) {
                    // Use formatted full address from structured fields or fallback to legacy field
                    const fullAddress = formatUserAddress(currentUser);
                    profileShippingAddress.textContent = fullAddress || 'ยังไม่ได้ระบุ';
                }
                const profileCreatedAt = document.getElementById('profileCreatedAt');
                if (profileCreatedAt) {
                    profileCreatedAt.textContent = formatThaiDate(currentUser.created_at);
                }
                const profileLastLogin = document.getElementById('profileLastLogin');
                if (profileLastLogin) {
                    profileLastLogin.textContent = formatThaiDate(currentUser.last_login);
                }

                // Update wallet information
                const profileThbBalance = document.getElementById('profileThbBalance');
                if (profileThbBalance) {
                    const balance = currentUser.wallet_balance || 0;
                    profileThbBalance.textContent = `฿${Number(balance).toLocaleString()}`;
                }
                const profileWldBalance = document.getElementById('profileWldBalance');
                if (profileWldBalance) {
                    const wldBalance = currentUser.wld_balance || 0;
                    profileWldBalance.textContent = `${wldBalance} WLD`;
                }

                // Update sales statistics
                const profileTotalSales = document.getElementById('profileTotalSales');
                if (profileTotalSales) {
                    profileTotalSales.textContent = currentUser.total_sales;
                }
                const profileSellerRating = document.getElementById('profileSellerRating');
                if (profileSellerRating) {
                    profileSellerRating.textContent = currentUser.seller_rating;
                }

                // Update referral information
                const profileReferralCode = document.getElementById('profileReferralCode');
                if (profileReferralCode) {
                    profileReferralCode.textContent = currentUser.referral_code;
                }

                // Load referrer information
                loadReferrerInfo(currentUser);

                // Calculate referral stats
                const referralStats = calculateReferralStats(currentUser.id);
                const referralStatValue = document.querySelector('.referral-stat-value');
                if (referralStatValue) {
                    referralStatValue.textContent = referralStats.referredUsers;
                }
                const referralStatValues = document.querySelectorAll('.referral-stat-value');
                if (referralStatValues.length > 1) {
                    referralStatValues[1].textContent = `฿${referralStats.totalBonus.toLocaleString()}`;
                }
            }
        }

        function formatThaiDate(dateString) {
            const thaiMonths = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];

            const date = new Date(dateString);
            const day = date.getDate();
            const month = thaiMonths[date.getMonth()];
            const year = date.getFullYear() + 543; // Convert to Buddhist Era

            return `${day} ${month} ${year}`;
        }

        function calculateReferralStats(userId) {
            const referredUsers = database.users.filter(user => user.referred_by === userId).length;
            const totalBonus = referredUsers * 200; // Assume 200 THB per referral

            return {
                referredUsers,
                totalBonus
            };
        }

        function copyReferralCode() {
            if (currentUser) {
                navigator.clipboard.writeText(currentUser.referral_code).then(() => {
                    // Show success message
                    const copyBtn = document.querySelector('.copy-btn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '✅';
                    copyBtn.style.background = '#10b981';

                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '#3b82f6';
                    }, 2000);
                });
            }
        }

        // User settings storage
        let userSettings = {
            language: 'ไทย',
            currency: 'THB',
            notifications: true,
            security: true
        };

        function editFullName() {
            var currentName = document.getElementById('profileFullName').textContent;
            var newName = prompt('แก้ไขชื่อ-นามสกุล:', currentName);

            if (newName && newName !== currentName && newName.trim()) {
                // อัพเดทใน UI
                document.getElementById('profileFullName').textContent = newName;

                // อัพเดทในฐานข้อมูล
                if (currentUser) {
                    currentUser.full_name = newName;
                    updateUserInDatabase(currentUser);
                }

                alert('✅ บันทึกชื่อสำเร็จ!');
            }
        }

        function editEmail() {
            var currentEmail = document.getElementById('profileEmail').textContent;
            var newEmail = prompt('แก้ไขอีเมล:', currentEmail);

            if (newEmail && newEmail !== currentEmail && newEmail.trim()) {
                if (newEmail.includes('@')) {
                    // อัพเดทใน UI
                    document.getElementById('profileEmail').textContent = newEmail;

                    // อัพเดทในฐานข้อมูล
                    if (currentUser) {
                        currentUser.email = newEmail;
                        updateUserInDatabase(currentUser);
                    }

                    alert('✅ บันทึกอีเมลสำเร็จ!');
                } else {
                    alert('❌ รูปแบบอีเมลไม่ถูกต้อง');
                }
            }
        }

        function editPhone() {
            var currentPhone = document.getElementById('profilePhone').textContent;
            var newPhone = prompt('แก้ไขเบอร์โทร (081-234-5678):', currentPhone);

            if (newPhone && newPhone !== currentPhone && newPhone.trim()) {
                // อัพเดทใน UI
                document.getElementById('profilePhone').textContent = newPhone;

                // อัพเดทในฐานข้อมูล
                if (currentUser) {
                    currentUser.phone = newPhone;
                    updateUserInDatabase(currentUser);
                }

                alert('✅ บันทึกเบอร์โทรสำเร็จ!');
            }
        }

        function editShippingAddress() {
            console.log('editShippingAddress called');
            console.log('currentUser:', currentUser);

            // Remove any existing address modal first
            const existingModal = document.querySelector('.address-edit-modal');
            if (existingModal) {
                console.log('Removing existing modal');
                existingModal.remove();
            }

            if (!currentUser) {
                alert('❌ ไม่พบข้อมูลผู้ใช้');
                return;
            }

            // Create a detailed address form instead of simple prompt
            const modal = document.createElement('div');
            modal.className = 'address-edit-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 20px;
            `;
            modal.innerHTML = `
                <div style="background-color: white; border-radius: 8px; padding: 24px; width: 100%; max-width: 400px; max-height: 500px; overflow-y: auto; position: relative;">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #374151;">แก้ไขที่อยู่</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px;">บ้านเลขที่/หมู่ที่</label>
                            <input type="text" id="addressNumber" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" value="${currentUser.address_number || ''}">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px;">ถนน/ซอย</label>
                            <input type="text" id="addressStreet" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" value="${currentUser.address_street || ''}">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px;">ตำบล/แขวง</label>
                            <input type="text" id="addressSubdistrict" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" value="${currentUser.address_subdistrict || ''}">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px;">อำเภอ/เขต</label>
                            <input type="text" id="addressDistrict" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" value="${currentUser.address_district || ''}">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px;">จังหวัด</label>
                            <select id="addressProvince" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">เลือกจังหวัด</option>
                                <option value="กรุงเทพมหานคร" ${currentUser.address_province === 'กรุงเทพมหานคร' ? 'selected' : ''}>กรุงเทพมหานคร</option>
                                <option value="กระบี่" ${currentUser.address_province === 'กระบี่' ? 'selected' : ''}>กระบี่</option>
                                <option value="กาญจนบุรี" ${currentUser.address_province === 'กาญจนบุรี' ? 'selected' : ''}>กาญจนบุรี</option>
                                <option value="กาฬสินธุ์" ${currentUser.address_province === 'กาฬสินธุ์' ? 'selected' : ''}>กาฬสินธุ์</option>
                                <option value="กำแพงเพชร" ${currentUser.address_province === 'กำแพงเพชร' ? 'selected' : ''}>กำแพงเพชร</option>
                                <option value="ขอนแก่น" ${currentUser.address_province === 'ขอนแก่น' ? 'selected' : ''}>ขอนแก่น</option>
                                <option value="จันทบุรี" ${currentUser.address_province === 'จันทบุรี' ? 'selected' : ''}>จันทบุรี</option>
                                <option value="ฉะเชิงเทรา" ${currentUser.address_province === 'ฉะเชิงเทรา' ? 'selected' : ''}>ฉะเชิงเทรา</option>
                                <option value="ชลบุรี" ${currentUser.address_province === 'ชลบุรี' ? 'selected' : ''}>ชลบุรี</option>
                                <option value="ชัยนาท" ${currentUser.address_province === 'ชัยนาท' ? 'selected' : ''}>ชัยนาท</option>
                                <option value="ชัยภูมิ" ${currentUser.address_province === 'ชัยภูมิ' ? 'selected' : ''}>ชัยภูมิ</option>
                                <option value="ชุมพร" ${currentUser.address_province === 'ชุมพร' ? 'selected' : ''}>ชุมพร</option>
                                <option value="เชียงราย" ${currentUser.address_province === 'เชียงราย' ? 'selected' : ''}>เชียงราย</option>
                                <option value="เชียงใหม่" ${currentUser.address_province === 'เชียงใหม่' ? 'selected' : ''}>เชียงใหม่</option>
                                <option value="ตรัง" ${currentUser.address_province === 'ตรัง' ? 'selected' : ''}>ตรัง</option>
                                <option value="ตราด" ${currentUser.address_province === 'ตราด' ? 'selected' : ''}>ตราด</option>
                                <option value="ตาก" ${currentUser.address_province === 'ตาก' ? 'selected' : ''}>ตาก</option>
                                <option value="นครนายก" ${currentUser.address_province === 'นครนายก' ? 'selected' : ''}>นครนายก</option>
                                <option value="นครปฐม" ${currentUser.address_province === 'นครปฐม' ? 'selected' : ''}>นครปฐม</option>
                                <option value="นครพนม" ${currentUser.address_province === 'นครพนม' ? 'selected' : ''}>นครพนม</option>
                                <option value="นครราชสีมา" ${currentUser.address_province === 'นครราชสีมา' ? 'selected' : ''}>นครราชสีมา</option>
                                <option value="นครศรีธรรมราช" ${currentUser.address_province === 'นครศรีธรรมราช' ? 'selected' : ''}>นครศรีธรรมราช</option>
                                <option value="นครสวรรค์" ${currentUser.address_province === 'นครสวรรค์' ? 'selected' : ''}>นครสวรรค์</option>
                                <option value="นนทบุรี" ${currentUser.address_province === 'นนทบุรี' ? 'selected' : ''}>นนทบุรี</option>
                                <option value="นราธิวาส" ${currentUser.address_province === 'นราธิวาส' ? 'selected' : ''}>นราธิวาส</option>
                                <option value="น่าน" ${currentUser.address_province === 'น่าน' ? 'selected' : ''}>น่าน</option>
                                <option value="บุรีรัมย์" ${currentUser.address_province === 'บุรีรัมย์' ? 'selected' : ''}>บุรีรัมย์</option>
                                <option value="ปทุมธานี" ${currentUser.address_province === 'ปทุมธานี' ? 'selected' : ''}>ปทุมธานี</option>
                                <option value="ประจวบคีรีขันธ์" ${currentUser.address_province === 'ประจวบคีรีขันธ์' ? 'selected' : ''}>ประจวบคีรีขันธ์</option>
                                <option value="ปราจีนบุรี" ${currentUser.address_province === 'ปราจีนบุรี' ? 'selected' : ''}>ปราจีนบุรี</option>
                                <option value="ปัตตานี" ${currentUser.address_province === 'ปัตตานี' ? 'selected' : ''}>ปัตตานี</option>
                                <option value="พระนครศรีอยุธยา" ${currentUser.address_province === 'พระนครศรีอยุธยา' ? 'selected' : ''}>พระนครศรีอยุธยา</option>
                                <option value="พะเยา" ${currentUser.address_province === 'พะเยา' ? 'selected' : ''}>พะเยา</option>
                                <option value="พังงา" ${currentUser.address_province === 'พังงา' ? 'selected' : ''}>พังงา</option>
                                <option value="พัทลุง" ${currentUser.address_province === 'พัทลุง' ? 'selected' : ''}>พัทลุง</option>
                                <option value="พิจิตร" ${currentUser.address_province === 'พิจิตร' ? 'selected' : ''}>พิจิตร</option>
                                <option value="พิษณุโลก" ${currentUser.address_province === 'พิษณุโลก' ? 'selected' : ''}>พิษณุโลก</option>
                                <option value="เพชรบุรี" ${currentUser.address_province === 'เพชรบุรี' ? 'selected' : ''}>เพชรบุรี</option>
                                <option value="เพชรบูรณ์" ${currentUser.address_province === 'เพชรบูรณ์' ? 'selected' : ''}>เพชรบูรณ์</option>
                                <option value="แพร่" ${currentUser.address_province === 'แพร่' ? 'selected' : ''}>แพร่</option>
                                <option value="ภูเก็ต" ${currentUser.address_province === 'ภูเก็ต' ? 'selected' : ''}>ภูเก็ต</option>
                                <option value="มหาสารคาม" ${currentUser.address_province === 'มหาสารคาม' ? 'selected' : ''}>มหาสารคาม</option>
                                <option value="มุกดาหาร" ${currentUser.address_province === 'มุกดาหาร' ? 'selected' : ''}>มุกดาหาร</option>
                                <option value="แม่ฮ่องสอน" ${currentUser.address_province === 'แม่ฮ่องสอน' ? 'selected' : ''}>แม่ฮ่องสอน</option>
                                <option value="ยโซธร" ${currentUser.address_province === 'ยโซธร' ? 'selected' : ''}>ยโซธร</option>
                                <option value="ยะลา" ${currentUser.address_province === 'ยะลา' ? 'selected' : ''}>ยะลา</option>
                                <option value="ร้อยเอ็ด" ${currentUser.address_province === 'ร้อยเอ็ด' ? 'selected' : ''}>ร้อยเอ็ด</option>
                                <option value="ระนอง" ${currentUser.address_province === 'ระนอง' ? 'selected' : ''}>ระนอง</option>
                                <option value="ระยอง" ${currentUser.address_province === 'ระยอง' ? 'selected' : ''}>ระยอง</option>
                                <option value="ราชบุรี" ${currentUser.address_province === 'ราชบุรี' ? 'selected' : ''}>ราชบุรี</option>
                                <option value="ลพบุรี" ${currentUser.address_province === 'ลพบุรี' ? 'selected' : ''}>ลพบุรี</option>
                                <option value="ลำปาง" ${currentUser.address_province === 'ลำปาง' ? 'selected' : ''}>ลำปาง</option>
                                <option value="ลำพูน" ${currentUser.address_province === 'ลำพูน' ? 'selected' : ''}>ลำพูน</option>
                                <option value="เลย" ${currentUser.address_province === 'เลย' ? 'selected' : ''}>เลย</option>
                                <option value="ศรีสะเกษ" ${currentUser.address_province === 'ศรีสะเกษ' ? 'selected' : ''}>ศรีสะเกษ</option>
                                <option value="สกลนคร" ${currentUser.address_province === 'สกลนคร' ? 'selected' : ''}>สกลนคร</option>
                                <option value="สงขลา" ${currentUser.address_province === 'สงขลา' ? 'selected' : ''}>สงขลา</option>
                                <option value="สตูล" ${currentUser.address_province === 'สตูล' ? 'selected' : ''}>สตูล</option>
                                <option value="สมุทรปราการ" ${currentUser.address_province === 'สมุทรปราการ' ? 'selected' : ''}>สมุทรปราการ</option>
                                <option value="สมุทรสงคราม" ${currentUser.address_province === 'สมุทรสงคราม' ? 'selected' : ''}>สมุทรสงคราม</option>
                                <option value="สมุทรสาคร" ${currentUser.address_province === 'สมุทรสาคร' ? 'selected' : ''}>สมุทรสาคร</option>
                                <option value="สระแก้ว" ${currentUser.address_province === 'สระแก้ว' ? 'selected' : ''}>สระแก้ว</option>
                                <option value="สระบุรี" ${currentUser.address_province === 'สระบุรี' ? 'selected' : ''}>สระบุรี</option>
                                <option value="สิงห์บุรี" ${currentUser.address_province === 'สิงห์บุรี' ? 'selected' : ''}>สิงห์บุรี</option>
                                <option value="สุโขทัย" ${currentUser.address_province === 'สุโขทัย' ? 'selected' : ''}>สุโขทัย</option>
                                <option value="สุพรรณบุรี" ${currentUser.address_province === 'สุพรรณบุรี' ? 'selected' : ''}>สุพรรณบุรี</option>
                                <option value="สุราษฎร์ธานี" ${currentUser.address_province === 'สุราษฎร์ธานี' ? 'selected' : ''}>สุราษฎร์ธานี</option>
                                <option value="สุรินทร์" ${currentUser.address_province === 'สุรินทร์' ? 'selected' : ''}>สุรินทร์</option>
                                <option value="หนองคาย" ${currentUser.address_province === 'หนองคาย' ? 'selected' : ''}>หนองคาย</option>
                                <option value="หนองบัวลำภู" ${currentUser.address_province === 'หนองบัวลำภู' ? 'selected' : ''}>หนองบัวลำภู</option>
                                <option value="อ่างทอง" ${currentUser.address_province === 'อ่างทอง' ? 'selected' : ''}>อ่างทอง</option>
                                <option value="อำนาจเจริญ" ${currentUser.address_province === 'อำนาจเจริญ' ? 'selected' : ''}>อำนาจเจริญ</option>
                                <option value="อุดรธานี" ${currentUser.address_province === 'อุดรธานี' ? 'selected' : ''}>อุดรธานี</option>
                                <option value="อุตรดิตถ์" ${currentUser.address_province === 'อุตรดิตถ์' ? 'selected' : ''}>อุตรดิตถ์</option>
                                <option value="อุทัยธานี" ${currentUser.address_province === 'อุทัยธานี' ? 'selected' : ''}>อุทัยธานี</option>
                                <option value="อุบลราชธานี" ${currentUser.address_province === 'อุบลราชธานี' ? 'selected' : ''}>อุบลราชธานี</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px;">รหัสไปรษณีย์</label>
                            <input type="text" id="addressPostalCode" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" value="${currentUser.address_postal_code || ''}">
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 24px;">
                        <button onclick="closeAddressModal()" style="padding: 8px 16px; background-color: #d1d5db; color: #374151; border: none; border-radius: 4px; cursor: pointer;">ยกเลิก</button>
                        <button onclick="saveAddress()" style="padding: 8px 16px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">บันทึก</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add modal functions to global scope
            window.closeAddressModal = function() {
                document.body.removeChild(modal);
                delete window.closeAddressModal;
                delete window.saveAddress;
            };

            window.saveAddress = function() {
                console.log('saveAddress called');
                const addressNumber = document.getElementById('addressNumber').value.trim();
                const addressStreet = document.getElementById('addressStreet').value.trim();
                const addressSubdistrict = document.getElementById('addressSubdistrict').value.trim();
                const addressDistrict = document.getElementById('addressDistrict').value.trim();
                const addressProvince = document.getElementById('addressProvince').value;
                const addressPostalCode = document.getElementById('addressPostalCode').value.trim();

                console.log('Address data:', {
                    addressNumber, addressStreet, addressSubdistrict,
                    addressDistrict, addressProvince, addressPostalCode
                });

                // Update user data with structured fields
                if (currentUser) {
                    currentUser.address_number = addressNumber;
                    currentUser.address_street = addressStreet;
                    currentUser.address_subdistrict = addressSubdistrict;
                    currentUser.address_district = addressDistrict;
                    currentUser.address_province = addressProvince;
                    currentUser.address_postal_code = addressPostalCode;

                    // Also update legacy field for backward compatibility
                    const fullAddress = formatUserAddress(currentUser);
                    currentUser.shipping_address = fullAddress;

                    // Update in database
                    updateUserInDatabase(currentUser);

                    // Update UI display
                    document.getElementById('profileShippingAddress').textContent = fullAddress || 'ยังไม่ได้ระบุ';
                }

                closeAddressModal();
                alert('✅ บันทึกที่อยู่สำเร็จ!');
            };
        }

        function editProfileImage() {
            // สร้าง input element สำหรับเลือกไฟล์
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = function(e) {
                var file = e.target.files[0];

                if (file) {
                    // ตรวจสอบประเภทไฟล์
                    if (!file.type.startsWith('image/')) {
                        alert('❌ กรุณาเลือกไฟล์รูปภาพเท่านั้น');
                        return;
                    }

                    // ตรวจสอบขนาดไฟล์ (จำกัดที่ 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('❌ ไฟล์รูปภาพใหญ่เกินไป\nขนาดสูงสุด: 5MB');
                        return;
                    }

                    // สร้างชื่อไฟล์ไม่ซ้ำกัน
                    const timestamp = Date.now();
                    const randomId = Math.random().toString(36).substring(2, 15);
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const uniqueFileName = `profile_${currentUser.id}_${timestamp}_${randomId}.${fileExtension}`;

                    console.log('Uploading profile image:', uniqueFileName);

                    // อัปโหลดไฟล์ไปเซิร์ฟเวอร์
                    uploadProfileImageToServer(file, currentUser.id);
                }
            };

            // เปิด dialog เลือกไฟล์
            input.click();
        }

        function editFullName() {
            var currentFullName = document.getElementById('profileFullName').textContent;
            var newFullName = prompt('แก้ไขชื่อจริง:', currentFullName);

            if (newFullName && newFullName !== currentFullName) {
                // อัพเดทใน UI
                document.getElementById('profileFullName').textContent = newFullName;

                // อัพเดทในฐานข้อมูล
                if (currentUser) {
                    currentUser.full_name = newFullName;
                    updateUserInDatabase(currentUser);
                }

                alert('✅ บันทึกชื่อจริงสำเร็จ!');
            }
        }

        // Display my inviter function
        function displayMyInviter(inviter) {
            const container = document.getElementById('myInviterInfo');

            if (!inviter) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 24px;">ไม่มีผู้แนะนำ</div>';
                return;
            }

            const initials = (inviter.full_name || inviter.username || 'U').charAt(0).toUpperCase();
            const joinDate = inviter.created_at ? new Date(inviter.created_at).toLocaleDateString('th-TH') : 'ไม่ทราบ';
            const displayName = inviter.full_name || inviter.username || 'ไม่ระบุ';

            // Check if inviter has profile image
            const hasProfileImage = inviter.profile_image || inviter.avatar_url;
            const avatarContent = hasProfileImage
                ? `<img src="${inviter.profile_image || inviter.avatar_url}" alt="${displayName}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">`
                : initials;

            container.innerHTML = `
                <div class="invited-user-card">
                    <div class="invited-user-avatar">${avatarContent}</div>
                    <div class="invited-user-info">
                        <div class="invited-user-name">👑 ${displayName}</div>
                        <div class="invited-user-date">ผู้แนะนำของคุณ • เข้าร่วม: ${joinDate}</div>
                    </div>
                </div>
            `;
        }

        // Display invited users function
        function displayInvitedUsers(invitees) {
            const listContainer = document.getElementById('invitedUsersList');

            if (!invitees || invitees.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 24px;">ยังไม่มีคนที่คุณชวนมา</div>';
                return;
            }

            listContainer.innerHTML = invitees.map(user => {
                const initials = (user.full_name || user.username || 'U').charAt(0).toUpperCase();
                const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString('th-TH') : 'ไม่ทราบ';
                const displayName = user.full_name || user.username || 'ไม่ระบุ';

                // Check if user has profile image
                const hasProfileImage = user.profile_image || user.avatar_url;
                const avatarContent = hasProfileImage
                    ? `<img src="${user.profile_image || user.avatar_url}" alt="${displayName}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">`
                    : initials;

                return `
                    <div class="invited-user-card">
                        <div class="invited-user-avatar">${avatarContent}</div>
                        <div class="invited-user-info">
                            <div class="invited-user-name">${displayName}</div>
                            <div class="invited-user-date">เข้าร่วม: ${joinDate}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }


        // Network/Referral Functions
        function copyMyReferralCode() {
            var code = document.getElementById('myReferralCode').value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    var btn = document.querySelector('.copy-code-btn');
                    var original = btn.textContent;
                    btn.textContent = '✅';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.style.background = '#3b82f6';
                    }, 2000);
                    alert('✅ คัดลอกรหัสแนะนำสำเร็จ!\n\n' + code);
                });
            } else {
                alert('รหัสแนะนำของคุณ: ' + code);
            }
        }

        function copyMyReferralLink() {
            var link = document.getElementById('myReferralLink').value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    var btn = document.querySelector('.copy-link-btn');
                    var original = btn.textContent;
                    btn.textContent = '✅';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.style.background = '#3b82f6';
                    }, 2000);
                    alert('✅ คัดลอกลิงค์แนะนำสำเร็จ!');
                });
            } else {
                alert('ลิงค์แนะนำของคุณ:\n\n' + link);
            }
        }

        // Load referrals data from database
        async function loadReferralsData() {
            console.log('Loading referrals data...');

            if (!currentUser) {
                console.log('No current user, skipping referrals load');
                return;
            }

            try {
                // Debug current user data
                console.log('Current user data:', currentUser);
                console.log('Current user invitor_id:', currentUser.invitor_id);
                console.log('Current user invited_by:', currentUser.invited_by);

                // Set invite code and referral link
                const inviteCode = currentUser.invite_code || '';
                const referralLink = inviteCode ? `${window.location.origin}/mobile/?invite=${inviteCode}` : '';

                document.getElementById('myReferralCode').value = inviteCode;
                document.getElementById('myReferralLink').value = referralLink;

                // Count users who were invited by this user
                const invitedUsers = await database.getAllUsers();
                console.log('All users for filtering:', invitedUsers.data?.map(u => ({
                    id: u.id,
                    username: u.username,
                    invitor_id: u.invitor_id,
                    invited_by: u.invited_by
                })));

                const myInvitees = invitedUsers.data ?
                    invitedUsers.data.filter(user => {
                        const userInvitor = user.invited_by || user.invitor_id;
                        return userInvitor === currentUser.id;
                    }) : [];

                console.log('Current user ID:', currentUser.id);
                console.log('Found invitees:', myInvitees.map(u => ({id: u.id, username: u.username})));

                // Update real referral count
                document.querySelector('#referrals .stat-card:first-child .stat-value').textContent = myInvitees.length;

                // Mock WLD data (not calculated from referrals)
                const mockWLD = 125.50;
                document.querySelector('#referrals .stat-card:nth-child(2) .stat-value').textContent = mockWLD.toFixed(2);

                // Mock Finpoint data
                const mockFinpoint = 2450;
                document.querySelector('#referrals .stat-card:nth-child(3) .stat-value').textContent = mockFinpoint.toLocaleString();

                // Find and display who invited current user
                const inviterID = currentUser.invited_by || currentUser.invitor_id;
                console.log('Looking for inviter with ID:', inviterID);
                console.log('Available users:', invitedUsers.data?.map(u => ({id: u.id, username: u.username})));

                let myInviter = null;
                if (inviterID) {
                    myInviter = invitedUsers.data ?
                        invitedUsers.data.find(user => user.id === inviterID) : null;
                }
                console.log('Found inviter:', myInviter);
                if (myInviter) {
                    console.log('Inviter profile_image:', myInviter.profile_image);
                    console.log('Inviter avatar_url:', myInviter.avatar_url);
                }
                displayMyInviter(myInviter);

                // Display invited users
                displayInvitedUsers(myInvitees);

                console.log(`Loaded referrals data: ${myInvitees.length} real invitees, ${mockWLD} WLD (mock), ${mockFinpoint} FP (mock)`);
                console.log('My inviter:', myInviter);

            } catch (error) {
                console.error('Error loading referrals data:', error);

                // Fallback to showing basic data
                const inviteCode = currentUser.invite_code || '';
                const referralLink = inviteCode ? `${window.location.origin}/mobile/?invite=${inviteCode}` : '';

                document.getElementById('myReferralCode').value = inviteCode;
                document.getElementById('myReferralLink').value = referralLink;
            }
        }

        function generateReferralLink(code) {
            return `${window.location.origin}/mobile/?invite=${code}`;
        }

        function generateQRCode() {
            var link = document.getElementById('myReferralLink').value;
            alert('📱 สร้าง QR Code\n\nลิงค์: ' + link + '\n\n[ในแอปจริงจะแสดง QR Code]');
        }

        function shareReferralLink() {
            var code = document.getElementById('myReferralCode').value;
            var link = document.getElementById('myReferralLink').value;

            var message = '🌱 มาร่วมกับ Fingrow V3 กันเถอะ!\n\n' +
                         '💰 ตลาดซื้อขายสินค้ามือสองพร้อม Worldcoin\n' +
                         '🎁 ใช้รหัสแนะนำ: ' + code + '\n' +
                         '🔗 ' + link + '\n\n' +
                         '✅ รับโบนัสทันทีเมื่อสมัคร!';

            if (navigator.share) {
                navigator.share({
                    title: 'Fingrow V3 - ตลาดซื้อขายสินค้ามือสอง',
                    text: message,
                    url: link
                });
            } else {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(message);
                    alert('✅ คัดลอกข้อความแชร์สำเร็จ!\n\nนำไปแชร์ในแอปอื่นได้เลย');
                } else {
                    alert('ข้อความแชร์:\n\n' + message);
                }
            }
        }

        function showReferralDetails() {
            alert('📊 รายละเอียดการแนะนำ\n\n' +
                  '👥 คนที่แนะนำ: 23 คน\n' +
                  '🎁 โบนัสรวม: 45.67 WLD\n' +
                  '💰 รายได้รวม: ฿11,540\n\n' +
                  '🔥 ระดับปัจจุบัน: Silver\n' +
                  '🎯 เป้าหมาย Gold: อีก 7 คน');
        }

        function showWalletDetails() {
            if (currentUser) {
                const thbBalance = currentUser.wallet_balance.toLocaleString();
                const wldBalance = currentUser.wld_balance;

                const choice = confirm(`💰 กระเป๋าเงินของคุณ\n\n• THB: ฿${thbBalance}\n• WLD: ${wldBalance}\n\n📊 ประวัติการทำธุรกรรม\n• ขายได้: ${currentUser.total_sales} รายการ\n• ซื้อแล้ว: 8 รายการ\n\n💳 คลิก OK เพื่อเติมเงิน | Cancel เพื่อปิด`);

                if (choice) {
                    const amount = prompt('เติมเงิน THB (ขั้นต่ำ 100 บาท):', '500');
                    if (amount && !isNaN(amount) && parseFloat(amount) >= 100) {
                        alert(`✅ เติมเงินสำเร็จ!\n\n💰 จำนวน: ฿${parseFloat(amount).toLocaleString()}\n📱 ชำระผ่าน: PromptPay\n⏰ เงินจะเข้าใน 1-2 นาที`);
                    } else if (amount) {
                        alert('❌ จำนวนเงินไม่ถูกต้อง (ขั้นต่ำ 100 บาท)');
                    }
                }
            }
        }

        function showSettings() {
            const settingsMenu = `⚙️ ตั้งค่าระบบ\n\n1. 🔔 การแจ้งเตือน: ${userSettings.notifications ? 'เปิด' : 'ปิด'}\n2. 🌍 ภาษา: ${userSettings.language}\n3. 💱 สกุลเงินหลัก: ${userSettings.currency}\n4. 🔒 ความปลอดภัย: ${userSettings.security ? 'เปิด' : 'ปิด'}\n5. 📊 ข้อมูลส่วนตัว\n6. 🔄 ซิงค์ข้อมูล\n7. 🎨 ธีม\n\nกรุณาเลือกหมายเลข 1-7 หรือพิมพ์ 'ยกเลิก'`;

            const choice = prompt(settingsMenu);

            switch(choice) {
                case '1':
                    toggleNotifications();
                    break;
                case '2':
                    changeLanguage();
                    break;
                case '3':
                    changeCurrency();
                    break;
                case '4':
                    toggleSecurity();
                    break;
                case '5':
                    alert('📊 ข้อมูลส่วนตัว\n\n• การรักษาความเป็นส่วนตัว: เข้มงวด\n• การแชร์ข้อมูล: ปิด\n• การติดตาม: ปิด');
                    break;
                case '6':
                    alert('🔄 กำลังซิงค์ข้อมูล...\n\n✅ ข้อมูลโปรไฟล์: อัพเดทแล้ว\n✅ ข้อมูลกระเป๋าเงิน: อัพเดทแล้ว\n✅ ประวัติการซื้อขาย: อัพเดทแล้ว');
                    break;
                case '7':
                    const themes = prompt('🎨 เลือกธีม:\n\n1. Dark (ปัจจุบัน)\n2. Light\n3. Auto\n\nเลือก 1-3:');
                    if (themes) {
                        const themeNames = ['', 'Dark', 'Light', 'Auto'];
                        alert(`✅ เปลี่ยนธีมเป็น: ${themeNames[themes]} สำเร็จ!`);
                    }
                    break;
            }
        }

        function contactSupport() {
            const contactOptions = `📞 ติดต่อเรา\n\n1. 💬 แชทออนไลน์ (24/7)\n2. 📧 อีเมล: support@fingrow.com\n3. 📱 Line: @fingrow\n4. ☎️ โทร: 02-123-4567\n5. 🏢 สำนักงาน: กรุงเทพฯ\n\n⏰ เวลาทำการ: จ-ศ 9:00-18:00\n\nเลือก 1-5 หรือพิมพ์ 'ยกเลิก'`;

            const choice = prompt(contactOptions);

            switch(choice) {
                case '1':
                    alert('💬 กำลังเชื่อมต่อแชทออนไลน์...\n\n👋 สวัสดีครับ! ทีม Fingrow ยินดีให้บริการ\n🕐 เวลาตอบ: โดยเฉลี่ย < 2 นาที\n\n[ในแอปจริงจะเปิดหน้าแชท]');
                    break;
                case '2':
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText('support@fingrow.com');
                        alert('📧 คัดลอกอีเมลเรียบร้อย!\n\nsupport@fingrow.com\n\n💡 เราจะตอบกลับภายใน 24 ชั่วโมง');
                    } else {
                        alert('📧 support@fingrow.com\n\n💡 เราจะตอบกลับภายใน 24 ชั่วโมง');
                    }
                    break;
                case '3':
                    alert('📱 Line Official Account\n\n🆔 @fingrow\n\n🔍 ค้นหาได้ใน Line App\n💬 แอดเป็นเพื่อนเพื่อรับข่าวสารและโปรโมชัน');
                    break;
                case '4':
                    alert('☎️ โทรศัพท์\n\n📞 02-123-4567\n⏰ จ-ศ 9:00-18:00\n\n💰 อัตราค่าบริการตามแพ็กเกจโทรศัพท์ของคุณ');
                    break;
                case '5':
                    alert('🏢 สำนักงานใหญ่\n\n📍 999/9 อาคาร Fingrow Tower\n    ถ.พหลโยธิน แขวงจตุจักร\n    เขตจตุจักร กรุงเทพฯ 10900\n\n🚇 BTS หมอชิต (ออกทางออกที่ 3)\n🚌 รถเมล์: 3, 39, 59\n\n⏰ เปิดให้บริการ: จ-ศ 9:00-17:00');
                    break;
            }
        }

        function changeLanguage() {
            const languages = ['ไทย', 'English', '中文', '日本語', 'Español'];
            const currentIndex = languages.indexOf(userSettings.language);
            const languageList = languages.map((lang, index) =>
                `${index + 1}. ${lang}${index === currentIndex ? ' (ปัจจุบัน)' : ''}`
            ).join('\n');

            const choice = prompt(`🌍 เลือกภาษา:\n\n${languageList}\n\nพิมพ์หมายเลข 1-${languages.length}:`);

            if (choice && choice >= 1 && choice <= languages.length) {
                userSettings.language = languages[choice - 1];
                document.getElementById('languageSetting').textContent = userSettings.language;
                alert(`✅ เปลี่ยนภาษาเป็น: ${userSettings.language} สำเร็จ!`);

                // In a real app, this would trigger language change
                if (userSettings.language !== 'ไทย') {
                    alert(`🔄 กำลังโหลดภาษา ${userSettings.language}...\n\n(ในเวอร์ชันจริงจะเปลี่ยนภาษาทั้งแอป)`);
                }
            }
        }

        function changeCurrency() {
            const currencies = [
                { code: 'THB', name: 'บาทไทย', symbol: '฿' },
                { code: 'USD', name: 'US Dollar', symbol: '$' },
                { code: 'EUR', name: 'Euro', symbol: '€' },
                { code: 'WLD', name: 'Worldcoin', symbol: 'WLD' },
                { code: 'BTC', name: 'Bitcoin', symbol: '₿' }
            ];

            const currentCurrency = currencies.find(c => c.code === userSettings.currency);
            const currencyList = currencies.map((curr, index) =>
                `${index + 1}. ${curr.code} - ${curr.name} (${curr.symbol})${curr.code === userSettings.currency ? ' (ปัจจุบัน)' : ''}`
            ).join('\n');

            const choice = prompt(`💱 เลือกสกุลเงินหลัก:\n\n${currencyList}\n\nพิมพ์หมายเลข 1-${currencies.length}:`);

            if (choice && choice >= 1 && choice <= currencies.length) {
                const selectedCurrency = currencies[choice - 1];
                userSettings.currency = selectedCurrency.code;
                document.getElementById('currencySetting').textContent = selectedCurrency.code;

                alert(`✅ เปลี่ยนสกุลเงินหลักเป็น: ${selectedCurrency.code} (${selectedCurrency.name}) สำเร็จ!\n\n💡 ราคาสินค้าจะแสดงเป็น ${selectedCurrency.symbol} เป็นหลัก`);

                // Update wallet display based on selected currency
                updateWalletDisplay();
            }
        }

        function toggleNotifications() {
            userSettings.notifications = !userSettings.notifications;
            const toggleElement = document.getElementById('notificationToggle');
            if (toggleElement) {
                toggleElement.textContent = userSettings.notifications ? 'เปิด' : 'ปิด';
                toggleElement.classList.toggle('inactive', !userSettings.notifications);
            }
            alert(`🔔 ${userSettings.notifications ? 'เปิด' : 'ปิด'}การแจ้งเตือนเรียบร้อยแล้ว!`);
        }

        function toggleSecurity() {
            userSettings.security = !userSettings.security;
            const toggleElement = document.getElementById('securityToggle');
            if (toggleElement) {
                toggleElement.textContent = userSettings.security ? 'เปิด' : 'ปิด';
                toggleElement.classList.toggle('inactive', !userSettings.security);
            }
            alert(`🔒 ${userSettings.security ? 'เปิด' : 'ปิด'}การรักษาความปลอดภัยเรียบร้อยแล้ว!`);
        }

        function updateWalletDisplay() {
            if (currentUser && userSettings.currency !== 'THB') {
                // Mock conversion rates
                const rates = {
                    'USD': 0.028,
                    'EUR': 0.026,
                    'WLD': currentUser.wld_balance / currentUser.wallet_balance,
                    'BTC': 0.0000012
                };

                if (rates[userSettings.currency]) {
                    const convertedAmount = (currentUser.wallet_balance * rates[userSettings.currency]).toFixed(2);
                    const symbols = { 'USD': '$', 'EUR': '€', 'WLD': '', 'BTC': '₿' };
                    const symbol = symbols[userSettings.currency] || '';

                    document.getElementById('profileThbBalance').textContent =
                        `${symbol}${convertedAmount}${userSettings.currency === 'WLD' ? ' WLD' : ''}`;
                }
            } else if (currentUser) {
                document.getElementById('profileThbBalance').textContent = `฿${currentUser.wallet_balance.toLocaleString()}`;
            }
        }

        function logout() {
            if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
                // Clear user data and redirect to login
                localStorage.removeItem('currentUser');
                currentUser = null;
                showPage('login');
                alert('✅ ออกจากระบบเรียบร้อยแล้ว');
            }
        }

        function loadReferrerInfo(user) {
            const referralSection = document.getElementById('referralSection');

            // Check if user has a referrer
            if (!user.referred_by) {
                referralSection.style.display = 'none';
                return;
            }

            try {
                // Get all users to find the referrer
                const users = JSON.parse(localStorage.getItem('fingrow_users') || '[]');
                const referrer = users.find(u => parseInt(u.id) === parseInt(user.referred_by));

                if (referrer) {
                    // Show referral section
                    referralSection.style.display = 'block';

                    // Update referrer image
                    const referrerImage = document.getElementById('referrerImage');
                    if (referrerImage) {
                        referrerImage.src = referrer.profile_image || 'https://images.unsplash.com/photo-1494790108755-2616b612b647?w=60&h=60&fit=crop&crop=face';
                    }

                    // Update referrer name
                    const referrerName = document.getElementById('referrerName');
                    if (referrerName) {
                        referrerName.textContent = referrer.full_name || referrer.username;
                    }

                    // Update referrer code
                    const referrerCode = document.getElementById('referrerCode');
                    if (referrerCode) {
                        referrerCode.textContent = `รหัส: ${referrer.referral_code}`;
                    }

                    // Update referrer date
                    const referrerDate = document.getElementById('referrerDate');
                    if (referrerDate) {
                        const joinDate = new Date(user.created_at).toLocaleDateString('th-TH');
                        referrerDate.textContent = `แนะนำเมื่อ: ${joinDate}`;
                    }

                    console.log('✅ Referrer info loaded:', referrer.username);
                } else {
                    console.warn('⚠️ Referrer not found for user:', user.username);
                    referralSection.style.display = 'none';
                }
            } catch (error) {
                console.error('❌ Error loading referrer info:', error);
                referralSection.style.display = 'none';
            }
        }
    </script>

    <!-- Product Detail Popup -->
    <div id="productPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h3 style="margin: 0; color: #f4f4f5; font-size: 16px;">รายละเอียดสินค้า</h3>
                <button class="popup-close" onclick="closeProductPopup()">&times;</button>
            </div>
            <div class="popup-body">
                <div class="product-image-gallery">
                    <img id="productMainImage" class="product-image-main" alt="Product Image">
                    <button id="imagePrevBtn" class="image-nav-btn image-nav-prev" onclick="prevProductImage()">‹</button>
                    <button id="imageNextBtn" class="image-nav-btn image-nav-next" onclick="nextProductImage()">›</button>
                    <div id="imageIndicators" class="image-indicators"></div>
                </div>
                <div class="product-detail-info">
                    <h2 id="productDetailTitle" class="product-detail-title"></h2>
                    <div id="productDetailPrice" class="product-detail-price"></div>
                    <div class="seller-location">
                        <span style="color: #94a3b8;">📍</span>
                        <span id="sellerProvince" style="color: #94a3b8; font-size: 14px;"></span>
                    </div>

                    <div class="product-detail-section">
                        <div class="product-detail-label">คำอธิบาย</div>
                        <div id="productDetailDescription" class="product-detail-value"></div>
                    </div>

                    <div class="product-detail-section">
                        <div class="product-detail-label">สภาพสินค้า</div>
                        <div id="productDetailCondition" class="product-detail-value"></div>
                    </div>

                    <div class="product-detail-section">
                        <div class="product-detail-label">หมวดหมู่</div>
                        <div id="productDetailCategory" class="product-detail-value"></div>
                    </div>

                    <div class="product-detail-section">
                        <div class="product-detail-label">จำนวนผู้ดู</div>
                        <div id="productDetailViews" class="product-detail-value"></div>
                    </div>

                    <div class="seller-info">
                        <div class="product-detail-label">ผู้ขาย</div>
                        <div class="seller-profile">
                            <img id="sellerProfileImage" class="seller-avatar" src="" alt="Profile">
                            <div class="seller-details">
                                <div id="sellerName" class="seller-name"></div>
                                <div class="seller-rating">
                                    <div class="rating-stars" id="sellerRatingStars"></div>
                                    <span id="sellerRatingText"></span>
                                    <span class="sales-count">(<span id="sellerSalesCount"></span> ยอดขาย)</span>
                                </div>
                                <div class="seller-stats">
                                    <span>เข้าร่วมเมื่อ: <span id="sellerJoinDate"></span></span>
                                    <span>สถานะ: <span id="sellerStatus"></span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="popup-actions">
                <button class="action-btn btn-secondary" onclick="contactSeller()">💬 แชท</button>
                <button class="action-btn btn-primary" onclick="buyProduct()">🛒 ซื้อเลย</button>
            </div>
        </div>
    </div>

</body>
</html>